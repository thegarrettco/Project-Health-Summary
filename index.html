<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EG Executive Dashboard</title>

  <!-- Google Fonts: Playfair Display + Poppins -->
  <link
    href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Poppins:wght@300;400;600&display=swap"
    rel="stylesheet"
  />

  <style>
    :root {
      --primary: #0070b9;
      --secondary: #333e4e;
      --accent: #fdb82b;
      --bg-light: #f8f9fb;
      --text-dark: #1e1e1e;

      --body-bg-image: url('https://static.wixstatic.com/media/4f7dd4_63f3cd73446e43f6bf97fb94b36ae893~mv2.png');
      --header-bg-image: url('https://static.wixstatic.com/media/4f7dd4_d05c939dec47458fa6367dd45bb71018~mv2.png');

      /* Shared min-width for excel-style tables (forces scroll instead of unreadable compression) */
      --excel-min-width: 980px;

      /* how far you want the scrollbar from the table */
      --excel-scrollbar-offset: 20px;

      /* Number coloring */
      --neg-red: #8b0000;    /* dark red */
      --pos-green: #0b5d1e;  /* dark green */

      /* Variance overlay tints */
      --pos-tint: rgba(11, 93, 30, 0.08);
      --neg-tint: rgba(139, 0, 0, 0.08);
    }

    body {
      font-family: "Poppins", sans-serif;
      background-color: var(--bg-light);
      color: var(--text-dark);
      margin: 0;
      padding: 0;
      background-image: var(--body-bg-image);
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }

    header {
      background-color: var(--secondary);
      color: white;
      padding: 1.5rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-image: var(--header-bg-image);
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }

    /* Default (desktop-first) */
    .logo-desktop {
      height: 45px;
      width: auto;
      vertical-align: middle;
    }

    .logo-mobile {
      display: none;
      height: 85px;
      width: auto;
      vertical-align: middle;
    }

    /* Mobile view */
    @media (max-width: 768px) {
      .logo-desktop { display: none; }
      .logo-mobile { display: inline-block; }
    }

    header h1 {
      font-family: "Poppins", sans-serif;
      font-size: 1.75rem;
      margin: 0;
    }

    .content {
      padding: 2rem 5%;
      animation: fadeIn 0.6s ease-in-out;
    }

    .dropdown-container {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    select {
      background-color: white;
      color: var(--secondary);
      border: none;
      border-radius: 6px;
      padding: 0.6rem 1.2rem;
      font-size: 1rem;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      max-width: 250px;
      min-width: 250px;
      overflow-y: auto;
      scrollbar-width: thin;
      max-height: 200px;
    }

    select option {
      padding: 0.4rem 0.8rem;
      font-size: 0.9rem;
    }

    select:focus {
      outline: 2px solid var(--primary);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .project-header {
      margin-bottom: 1.5rem;
    }

    .project-header h2 {
      font-family: "Poppins", sans-serif;
      font-size: 3.2rem;
      color: var(--secondary);
      margin-bottom: -1.2rem;
    }

    .project-header h3 {
      font-size: 1.6rem;
      font-weight: 500;
      color: var(--primary);
      margin-bottom: 3rem;
    }

    /* ====== MAIN GRID (2 columns) ====== */
    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      align-items: stretch;
    }

    /* make specific cards span both columns */
    .span-two {
      grid-column: 1 / -1;
    }

    .left-column, .right-column {
      display: flex;
      flex-direction: column;
      justify-content: flex-start; /* default stacking */
      gap: 1.5rem;
      min-width: 0;
    }

    /* Preserve your existing spacing behavior ONLY for real project pages */
    .main-grid.is-project .left-column,
    .main-grid.is-project .right-column {
      justify-content: space-between;
    }

    /* ===========================
       ✅ COVER PAGE (PORTFOLIO) ONLY
       =========================== */
    .main-grid.is-portfolio {
      grid-template-columns: 1fr;
    }
    .main-grid.is-portfolio .left-column,
    .main-grid.is-portfolio .right-column {
      display: none;
    }

    /* Let the gallery grow so it can reach the bottom and align with the map */
    .main-grid.is-portfolio #galleryCard {
      flex: 1 1 auto;
      min-height: 300px;
    }

    /* Keep map card filling remaining space (explicit, safe) */
    .main-grid.is-portfolio #mapCard {
      flex: 1 1 auto;
    }

    /* Remove the desktop inset look on the HOME page map only */
    .main-grid.is-portfolio #mapCard iframe {
      width: 100%;
      height: 100%;
    }

    /* ==========================================================
       ✅ CARD BASES
       IMPORTANT: Keep rendering/map padding behavior unchanged.
       We standardize title spacing via .card-header and give
       consistent padding-top via padding: 1.5rem here.
       ========================================================== */
    .investment-highlights,
    .property-details,
    .financial-section {
      background: white;
      border-radius: 16px;
      padding: 1.5rem; /* ✅ standardized padding (adds top padding) */
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      transition: transform 0.2s ease;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    /* rendering + map intentionally keep their own padding rules */
    .rendering-section,
    .map-section {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      transition: transform 0.2s ease;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .investment-highlights:hover,
    .property-details:hover,
    .financial-section:hover,
    .rendering-section:hover,
    .map-section:hover {
      transform: translateY(-4px);
    }

    /* ==========================================================
       ✅ CONSISTENT TITLE / HEADER ROW (bulleted + non-excel)
       ========================================================== */
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      margin-bottom: 1rem; /* consistent spacing under title row */
    }

    .card-header h4 {
      font-size: 1.35rem; /* matches excel-card-title */
      color: var(--secondary);
      margin: 0;
      line-height: 1.2;
    }

    /* Bullets block spacing remains consistent */
    .investment-highlights ul {
      list-style: disc;
      padding-left: 1.2rem;
      line-height: 1.6;
      margin: 0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      text-align: left;
      padding: 0.5rem 0;
    }

    th {
      font-weight: 600;
      color: var(--secondary);
    }

    .financial-metrics {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
      padding-top: 0.75rem;
    }

    .metric-card {
      background: var(--body-bg-image);
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      border-radius: 12px;
      padding: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      text-align: center;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .metric-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .metric-label {
      font-size: 0.9rem;
      color: var(--secondary);
    }

    .metric-value {
      font-size: 1.6rem;
      font-weight: 600;
      color: var(--primary);
    }

    /* ✅ Variance value coloring + faint overlay */
    .metric-value.variance-positive { color: var(--pos-green); }
    .metric-value.variance-negative { color: var(--neg-red); }

    .metric-card.variance-card {
      position: relative;
      overflow: hidden;
    }
    .metric-card.variance-card::after {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      opacity: 0; /* default off */
      transition: opacity 0.2s ease;
    }
    .metric-card.variance-card.variance-positive::after {
      background: var(--pos-tint);
      opacity: 1;
    }
    .metric-card.variance-card.variance-negative::after {
      background: var(--neg-tint);
      opacity: 1;
    }

    /* keep text above overlay */
    .metric-card.variance-card .metric-label,
    .metric-card.variance-card .metric-value,
    .metric-card.variance-card .metric-details {
      position: relative;
      z-index: 1;
    }

    /* ==============================
       "Excel-style" tables
       ============================== */
    .excel-card {
      position: relative;
      padding-top: 1.2rem;
    }

    .excel-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      margin-bottom: 0.9rem;
    }

    .excel-card-title {
      font-size: 1.35rem;
      color: var(--secondary);
      margin: 0;
      line-height: 1.2;
    }

    .excel-card-badge {
      background: #fff2d9;
      color: #111;
      font-weight: 700;
      font-size: 0.85rem;
      padding: 0.35rem 0.6rem;
      border-radius: 10px;
      white-space: nowrap;
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }

    /* Always allow horizontal scroll (desktop/tablet/mobile) */
    .excel-table-wrap {
      width: 100%;
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      border-radius: 12px;
      position: relative;

      /* ✅ key change: no forced extra space unless scrollbar exists */
      padding-bottom: 0;

      scrollbar-width: thick;
      scrollbar-color: rgba(0, 112, 185, 0.07);
    }

    /* ✅ only when there IS horizontal overflow do we add spacing */
    .excel-table-wrap.has-x-scroll {
      padding-bottom: var(--excel-scrollbar-offset);
    }

    .excel-table-wrap::-webkit-scrollbar { height: 12px; }
    .excel-table-wrap::-webkit-scrollbar-track {
      background: rgba(0,0,0,0.07);
      border-radius: 999px;
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.12);
    }
    .excel-table-wrap::-webkit-scrollbar-thumb {
      background: #b4b4b4;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,0.85);
    }
    .excel-table-wrap::-webkit-scrollbar-thumb:hover {
      background: rgba(0, 112, 185, 0.07);
    }

    .excel-table-wrap::before,
    .excel-table-wrap::after {
      content: "";
      position: sticky;
      top: 0;
      bottom: 0;
      width: 18px;
      pointer-events: none;
      z-index: 2;
    }
    .excel-table-wrap::before {
      left: 0;
      float: left;
      background: linear-gradient(90deg, rgba(255,255,255,0.95), rgba(255,255,255,0));
    }
    .excel-table-wrap::after {
      right: 0;
      float: right;
      background: linear-gradient(270deg, rgba(255,255,255,0.95), rgba(255,255,255,0));
    }

    .excel-table {
      display: inline-table;
      width: max-content;
      min-width: max(100%, var(--excel-min-width));
      border-collapse: separate;
      border-spacing: 0;
      table-layout: auto;
      background: #fff;
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 12px;
      overflow: hidden;
    }

    .excel-table thead th {
      background: rgba(0, 112, 185, 0.07);
      color: var(--secondary);
      font-weight: 700;
      font-size: 0.85rem;
      letter-spacing: 0.2px;
      padding: 0.65rem 0.75rem;
      border-bottom: 1px solid rgba(0,0,0,0.08);
      white-space: nowrap;
    }

    .excel-table tbody td {
      padding: 0.6rem 0.75rem;
      border-bottom: 1px solid rgba(0,0,0,0.06);
      font-size: 0.9rem;
      white-space: nowrap;
      overflow: visible;
      text-overflow: clip;
    }

    .excel-table tbody tr:last-child td { border-bottom: none; }

    .excel-row-label { font-weight: 600; color: var(--secondary); }

    .excel-number {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    .excel-muted { color: rgba(51, 62, 78, 0.6); }

    .excel-section-header td {
      padding: 0.55rem 0.75rem;
      background: rgba(51, 62, 78, 0.06);
      color: var(--secondary);
      font-weight: 800;
      letter-spacing: 0.2px;
      border-bottom: 1px solid rgba(0,0,0,0.08);
    }

    .excel-subtotal td {
      font-weight: 800;
      background: rgba(0, 112, 185, 0.06);
      border-top: 1px solid rgba(0,0,0,0.08);
      border-bottom: 1px solid rgba(0,0,0,0.06);
    }

    .excel-total td {
      font-weight: 800;
      background: rgba(253, 184, 43, 0.18);
      border-top: 1px solid rgba(0,0,0,0.10);
    }

    .excel-divider td {
      padding: 0;
      height: 8px;
      background: transparent;
      border-bottom: none;
    }

    /* numeric coloring helpers */
    .excel-table td.excel-number.is-negative { color: var(--neg-red); }
    .excel-table td.excel-number.is-positive { color: var(--pos-green); }

    .excel-table tr.excel-subtotal td.excel-number.total-positive,
    .excel-table tr.excel-total td.excel-number.total-positive {
      color: var(--pos-green);
    }

    /* ✅ clickable project name in cover tables (no blue/underline) */
    .excel-link {
      color: inherit;
      text-decoration: none;
      cursor: pointer;
    }
    .excel-link:hover,
    .excel-link:active,
    .excel-link:visited {
      color: inherit;
      text-decoration: none;
    }
    
    /* Entrata Box Score: match excel table body sizing */
#leasingCard table td {
  font-size: 0.9rem;
}

/* Optional: match header sizing too (if you have <th> rows in Entrata table) */
#leasingCard table th {
  font-size: 0.9rem;
}

    /* GALLERY */
    .rendering-section {
      position: relative;
      min-height: 300px;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      padding: 0;
    }

    .gallery-slide { display: none; width: 100%; height: 100%; }

    .gallery-slide img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 16px;
    }

    .prev, .next {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      padding: 0.5rem 0.8rem;
      color: white;
      font-weight: bold;
      font-size: 1.5rem;
      cursor: pointer;
      background: rgba(0, 0, 0, 0.4);
      border-radius: 16px;
      user-select: none;
      z-index: 10;
    }

    .prev:hover, .next:hover { background: rgba(0, 0, 0, 0.6); }

    .prev { left: 10px; }
    .next { right: 10px; }

    .fade { animation-name: fade; animation-duration: 0.8s; }

    @keyframes fade {
      from { opacity: 0.4; }
      to { opacity: 1; }
    }

    /* ✅ DroneDeploy badge on gallery (top-right) */
    .gallery-badge {
      position: absolute;
      top: 12px;
      right: 12px;
      z-index: 20;
      background: #fff2d9;
      color: #111;
      font-weight: 800;
      font-size: 0.85rem;
      padding: 0.35rem 0.6rem;
      border-radius: 10px;
      white-space: nowrap;
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
      pointer-events: none;
      display: none; /* shown when we have a date */
    }

    /* ✅ Optional small status text if DroneDeploy fails (keeps layout unchanged) */
    .gallery-status {
      position: absolute;
      left: 12px;
      bottom: 12px;
      z-index: 20;
      background: rgba(0,0,0,0.35);
      color: #fff;
      padding: 6px 10px;
      border-radius: 10px;
      font-size: 0.8rem;
      display: none;
      max-width: calc(100% - 24px);
    }

    .map-section {
      flex: 1;
      overflow: hidden;
      min-height: 300px;
      padding: 0;
      justify-content: center;
      align-items: center;
    }

    .map-section iframe {
      border: 0;
      width: 95%;
      height: 95%;
      display: block;
      border-radius: 16px;
    }

    .metric-details {
      font-size: 0.85rem;
      color: var(--secondary);
      margin-top: 0.5rem;
      transition: all 0.3s ease;
    }

    /* ===========================
       MOBILE / TABLET
       =========================== */
    @media (max-width: 900px) {
      .main-grid { grid-template-columns: 1fr; }
      .financial-metrics { grid-template-columns: 1fr; }

      .dropdown-container {
        flex-direction: column;
        gap: 0.8rem;
        align-items: stretch;
      }

      .dropdown-container select {
        width: 100%;
        min-width: 230px;
        max-width: 230px;
      }

      .project-header h2 { font-size: 2.2rem; }

      .map-section {
        flex: 1;
        overflow: hidden;
        height: 300px;
        padding: 10px;
        justify-content: center;
        align-items: center;
      }

      /* on 1-column layout, spanning is naturally 100% width */
      .span-two { grid-column: auto; }

      /* ==========================================================
         ✅ MOBILE-ONLY ORDER SHUFFLE (NON-COVER PAGES ONLY)
         Updated to include Garrett Mesa-only extras.
         ========================================================== */
      .main-grid.is-project {
        grid-template-columns: 1fr;
        grid-template-areas:
          "psu"
          "weeklycac"
          "svu"
          "smartpm"
          "ph"
          "cf"
          "notes"
          "asset"
          "profit"
          "leasing"
          "gallery"
          "map";
      }

      .main-grid.is-project .left-column,
      .main-grid.is-project .right-column {
        display: contents;
      }

      .main-grid.is-project #projectScheduleCard      { grid-area: psu; }
      .main-grid.is-project #weeklyCACNotesCard       { grid-area: weeklycac; }
      .main-grid.is-project #scheduleVarianceCard     { grid-area: svu; }
      .main-grid.is-project #smartPMKeyMilestonesCard { grid-area: smartpm; }

      .main-grid.is-project #projectHealthCard     { grid-area: ph; }
      .main-grid.is-project #cashFlowCard          { grid-area: cf; }

      .main-grid.is-project #notesCard             { grid-area: notes; }
      .main-grid.is-project #assetManagementCard   { grid-area: asset; }

      .main-grid.is-project #profitSummaryCard     { grid-area: profit; }
      .main-grid.is-project #leasingCard           { grid-area: leasing; }
      .main-grid.is-project #galleryCard           { grid-area: gallery; }
      .main-grid.is-project #mapCard               { grid-area: map; }

      .main-grid.is-project #projectScheduleCard,
      .main-grid.is-project #weeklyCACNotesCard,
      .main-grid.is-project #scheduleVarianceCard,
      .main-grid.is-project #smartPMKeyMilestonesCard,
      .main-grid.is-project #projectHealthCard,
      .main-grid.is-project #cashFlowCard,
      .main-grid.is-project #notesCard,
      .main-grid.is-project #assetManagementCard,
      .main-grid.is-project #profitSummaryCard,
      .main-grid.is-project #leasingCard,
      .main-grid.is-project #galleryCard,
      .main-grid.is-project #mapCard {
        grid-column: 1 / -1;
      }

      .main-grid.is-project #mapCard iframe {
        width: 100%;
        height: 100%;
      }
    }
  </style>
</head>

<!-- Favicons -->
<link rel="icon" href="https://static.wixstatic.com/media/4f7dd4_fa97d3a434c14b45a582dd8e3459bdfe~mv2.png" type="image/x-icon">
<link rel="icon" type="image/png" sizes="32x32" href="https://static.wixstatic.com/media/4f7dd4_fa97d3a434c14b45a582dd8e3459bdfe~mv2.png">
<link rel="apple-touch-icon" sizes="180x180" href="https://static.wixstatic.com/media/4f7dd4_fa97d3a434c14b45a582dd8e3459bdfe~mv2.png">

<body>
  <header>
    <h1>
      <a href="#" class="logo-link" id="logoLinkDesktop" aria-label="Go to Full TGC Portfolio">
        <img src="https://static.wixstatic.com/media/4f7dd4_2baa0e2530394de3af14df33ce1cdfe9~mv2.png" alt="The Garrett Companies" class="logo-desktop">
      </a>
      <a href="#" class="logo-link" id="logoLinkMobile" aria-label="Go to Full TGC Portfolio">
        <img src="https://static.wixstatic.com/media/4f7dd4_70a90d24ec5746faa3b0ec0ace16b262~mv2.png" alt="The Garrett Companies" class="logo-mobile">
      </a>
    </h1>

    <div class="dropdown-container">
      <select id="stateSelector">
        <option value="" disabled selected>Select State</option>
      </select>

      <select id="projectSelector">
        <option value="" disabled selected>Select Project</option>
      </select>
    </div>
  </header>

  <div class="content" id="projectContent">
    <div class="project-header">
      <h2></h2>
      <h3></h3>
    </div>

    <div class="main-grid">
      <!-- ==========================================================
           ✅ COVER PAGE ONLY (tgcportfolio): 3 FULL-WIDTH EXCEL TABLES
           ========================================================== -->

      <div class="financial-section excel-card span-two" id="coverProjectHealthSummaryCard" style="display:none;">
        <div class="excel-card-header">
          <h4 class="excel-card-title" style="margin:0;">Project Health Summary</h4>
          <div class="excel-card-badge" id="coverProjectHealthSummaryBadge" style="display:none;"></div>
        </div>

        <div class="excel-table-wrap">
          <table class="excel-table" id="coverProjectHealthSummaryTable" aria-label="Project Health Summary Table"></table>
        </div>
      </div>

      <div class="financial-section excel-card span-two" id="coverCACVarianceOverviewCard" style="display:none;">
        <div class="excel-card-header">
          <h4 class="excel-card-title" style="margin:0;">CAC Variance Overview</h4>
          <div class="excel-card-badge" id="coverCACVarianceOverviewBadge" style="display:none;"></div>
        </div>

        <div class="excel-table-wrap">
          <table class="excel-table" id="coverCACVarianceOverviewTable" aria-label="CAC Variance Overview Table"></table>
        </div>
      </div>

      <div class="financial-section excel-card span-two" id="coverPortfolioLeasingUpdateCard" style="display:none;">
        <div class="excel-card-header">
          <h4 class="excel-card-title" style="margin:0;">Portfolio Leasing Update</h4>
          <div class="excel-card-badge" id="coverPortfolioLeasingUpdateBadge" style="display:none;"></div>
        </div>

        <div class="excel-table-wrap">
          <table class="excel-table" id="coverPortfolioLeasingUpdateTable" aria-label="Portfolio Leasing Update Table"></table>
        </div>
      </div>

      <!-- ✅ FULL-WIDTH ROW #1 (PROJECT PAGES ONLY) -->
      <div class="financial-section excel-card span-two" id="projectScheduleCard" style="display:none;">
        <div class="excel-card-header">
          <h4 class="excel-card-title" style="margin:0;">CAC Variance Update</h4>
          <div class="excel-card-badge" id="projectScheduleBadge" style="display:none;"></div>
        </div>

        <div class="excel-table-wrap">
          <table class="excel-table" id="projectScheduleTable" aria-label="CAC Variance Update Table"></table>
        </div>
      </div>

      <!-- ✅ Garrett Mesa ONLY: Weekly CAC Notes (bulleted) -->
      <div class="investment-highlights span-two" id="weeklyCACNotesCard" style="display:none;">
        <div class="card-header">
          <h4>Weekly CAC Notes</h4>
        </div>
        <ul id="weeklyCACNotesList"></ul>
      </div>

      <!-- ✅ FULL-WIDTH ROW #2 (PROJECT PAGES ONLY) -->
      <div class="financial-section excel-card span-two" id="scheduleVarianceCard" style="display:none;">
        <div class="excel-card-header">
          <h4 class="excel-card-title" style="margin:0;">Schedule Variance Update</h4>
          <div class="excel-card-badge" id="scheduleVarianceBadge" style="display:none;"></div>
        </div>

        <div class="excel-table-wrap">
          <table class="excel-table" id="scheduleVarianceTable" aria-label="Schedule Variance Update Table"></table>
        </div>
      </div>

      <!-- ✅ Garrett Mesa ONLY: SmartPM Key Milestones (excel) -->
      <div class="financial-section excel-card span-two" id="smartPMKeyMilestonesCard" style="display:none;">
        <div class="excel-card-header">
          <h4 class="excel-card-title" style="margin:0;">SmartPM Key Milestones</h4>
          <div class="excel-card-badge" id="smartPMKeyMilestonesBadge" style="display:none;"></div>
        </div>

        <div class="excel-table-wrap">
          <table class="excel-table" id="smartPMKeyMilestonesTable" aria-label="SmartPM Key Milestones Table"></table>
        </div>
      </div>

      <!-- ✅ REMAINING SECTIONS KEEP THEIR 2-COLUMN LAYOUT (DESKTOP) -->
      <div class="left-column">
        <div class="financial-section excel-card" id="projectHealthCard" style="display:none;">
          <div class="excel-card-header">
            <h4 class="excel-card-title" style="margin:0;">Project Health</h4>
            <div class="excel-card-badge" id="projectHealthAsOfBadge" style="display:none;"></div>
          </div>

          <div class="excel-table-wrap">
            <table class="excel-table" id="projectHealthTable" aria-label="Project Health Table"></table>
          </div>
        </div>

        <!-- Profit Summary moved to LEFT column -->
<div class="financial-section" id="profitSummaryCard" style="display:none;">
  <div class="card-header">
    <h4>Profit Summary &amp; GC Projections</h4>
  </div>

  <div class="financial-metrics" id="profitSummaryMetrics">

    <!-- ========================= -->
    <!--      PROFIT SUMMARY      -->
    <!-- ========================= -->

    <!-- ORIGINAL PROFIT -->
    <div class="metric-card" id="profit-original-card">
      <div class="metric-label">Original Profit</div>
      <div class="metric-value" id="profit-original-total">—</div>
      <div class="metric-details" id="profit-original-details"></div>
    </div>

    <!-- ACTUAL PROFIT -->
    <div class="metric-card" id="profit-actual-card">
      <div class="metric-label">Actual Profit</div>
      <div class="metric-value" id="profit-actual-total">—</div>
      <div class="metric-details" id="profit-actual-details"></div>
    </div>

    <!-- VARIANCE -->
    <div class="metric-card variance-card" id="profit-variance-card">
      <div class="metric-label">Total Variance</div>
      <div class="metric-value" id="profit-variance-total">—</div>
      <div class="metric-details" id="profit-variance-details"></div>
    </div>

    <!-- ========================= -->
    <!--      GC PROJECTIONS      -->
    <!-- ========================= -->

    <!-- SWAG PER MONTH -->
    <div class="metric-card" id="gc-swag-card">
      <div class="metric-label">SWAG per Month</div>
      <div class="metric-value" id="gc-swag-total">—</div>
    </div>

    <!-- MONTHS REMAINING -->
    <div class="metric-card" id="gc-months-card">
      <div class="metric-label">Months Remaining</div>
      <div class="metric-value" id="gc-months-total">—</div>
      <div class="metric-details" id="gc-months-details"></div>
    </div>

    <!-- GC COST REMAINING -->
    <div class="metric-card" id="gc-cost-card">
      <div class="metric-label">GC Cost Remaining</div>
      <div class="metric-value" id="gc-cost-total">—</div>
    </div>

  </div>
</div>

        <!-- Entrata Box Score (badge in usual top-right spot) -->
        <div class="property-details" id="leasingCard" style="display:none;">
          <div class="card-header">
            <h4>Entrata Box Score</h4>
            <div class="excel-card-badge" id="entrataBoxScoreBadge" style="display:none;"></div>
          </div>
          <table></table>
        </div>

        <!-- DroneDeploy Integration (gallery) -->
        <div class="rendering-section" id="galleryCard" style="display:none;"></div>
      </div>

      <div class="right-column">
        <div class="financial-section excel-card" id="cashFlowCard" style="display:none;">
          <div class="excel-card-header">
            <h4 class="excel-card-title" style="margin:0;">Cash Flow</h4>
            <div class="excel-card-badge" id="cashFlowAsOfBadge" style="display:none;"></div>
          </div>

          <div class="excel-table-wrap">
            <table class="excel-table" id="cashFlowTable" aria-label="Cash Flow Table"></table>
          </div>
        </div>

        <!-- Notes & Updates directly under Cash Flow -->
<div class="investment-highlights" id="notesCard" style="display:none;">
  <div class="card-header">
    <h4>Health Notes &amp; Updates</h4>
    <span id="healthNotesAsOfBadge" class="asOfBadge"></span>
  </div>
  <ul id="healthNotesList"></ul>
</div>


        <!-- Asset Management Tracker (excel) -->
        <div class="financial-section excel-card" id="assetManagementCard" style="display:none;">
          <div class="excel-card-header">
            <h4 class="excel-card-title" style="margin:0;">Asset Management Tracker</h4>
            <div class="excel-card-badge" id="assetManagementBadge" style="display:none;"></div>
          </div>
          <div class="excel-table-wrap">
            <table class="excel-table" id="assetManagementTable" aria-label="Asset Management Tracker Table"></table>
          </div>
        </div>

        <!-- Map under Asset Management Tracker -->
        <div class="map-section" id="mapCard" style="display:none;">
          <iframe allowfullscreen loading="lazy"></iframe>
        </div>
      </div>
    </div>
  </div>
<script>
/* ============================================================
   ✅ DroneDeploy CONFIG — PASTE YOUR API KEY HERE (TEMP)
   ============================================================ */
const DRONEDEPLOY_API_KEY = "3164868b7ddd4b9fa8bd9f9307cdba16"; // <-- API key goes here
const DRONEDEPLOY_GRAPHQL_ENDPOINT = "https://www.dronedeploy.com/graphql";
const DRONEDEPLOY_REFRESH_MS = 60 * 60 * 1000; // every hour

/* ============================================================
   ✅ Entrata CONFIG
   ============================================================ */
const ENTRATA_ENDPOINT = "https://api.thegarrettcompanies.entrata.com/r2";

/* ============================================================
   Existing projects data
   ============================================================ */
const projects = {
  tgcportfolio: {
    name: "EG Executive Dashboard",
    location: "Garrett Construction Pipeline",
    highlights: [
      "Portfolio/Nationwide Construction Higlight will go in this space. Big picture!",
      "Portfolio/Nationwide Construction Higlight will go in this space. Big picture!",
      "Portfolio/Nationwide Construction Higlight will go in this space. Big picture!"
    ],
    details: {
      "Projects":"14",
      "Markets":"14",
      "States":"6",
      "Units":"3,641",
      "Delivery Window":"Q1 2028 - Q4 2029",
      "Target Sale Window":"2029 - 2031",
      "Prototypes":"4",
      "Average Site Area":"13.07 Acres",
      "Total Site Area":"169.9 Acres",
      "Average Unit Size":"1,002 SF"
    },
    financials: {
      "Average Market Rent": { value: "$2,207", details: "<b>One-Bedrooms:</b> $1,820<br><b>Two-Bedrooms:</b> $2,393<br><b>Three-Bedrooms:</b> $2,833<br>" },
      "Avg Market Rent PSF": { value: "$2.20", details: "<b>One-Bedrooms:</b> $2.42<br><b>Two-Bedrooms:</b> $2.08<br><b>Three-Bedrooms:</b> $2.15<br>" },
      "Total Project Expenses": { value: "$1.126B", details: "<b>Debt:</b> $735.44M (65.0%)<br><b>LP Equity:</b> $351.97M (90.0%)" },
      "Avg Cost Per Unit":"$282K",
      "Total Sale Price": "$1.061B",
      "Exit Price/Unit":"$372k",
      "Avg Yield":"6.98%",
      "Avg Exit Cap Rate":"5.44%"
    },

    coverProjectHealthSummary: {
      badge: "As of 2/17/2026",
      columns: ["Project", "Original Profit", "Actual Profit", "Total Variance", "Remaining Contingency", "GC Risk", "% Cash Collected", "Do Not Touch", "Construction Fee", "Development Fee"],
      rows: [
        { label: "Aspire on 10th", values: ["—", "—", "—", "—", "—", "—", "—", "—", "—"] },
        { label: "Banyan", values: ["—", "—", "—", "—", "—", "—", "—", "—", "—"] },
        { label: "Deleware Powers Place", values: ["—", "—", "—", "—", "—", "—", "—", "—", "—"] },
        { label: "County Line", values: ["—", "—", "—", "—", "—", "—", "—", "—", "—"] },
        { label: "Garrett Mesa", values: ["$6,220,828.00", "$9,303,351.65", "$3,082,523.65", "$170,767.32", "$320,396.51", "79%", "$4,139,116.33", "$2,332,323.09", "$2,711,830.00"] },
        { label: "Fillmore", values: ["—", "—", "—", "—", "—", "—", "—", "—", "—"] },
        { label: "Flying Horse", values: ["—", "—", "—", "—", "—", "—", "—", "—", "—"] },
        { label: "FM Gateway", values: ["—", "—", "—", "—", "—", "—", "—", "—", "—"] },
        { label: "Forum II", values: ["—", "—", "—", "—", "—", "—", "—", "—", "—"] },
        { label: "Havana", values: ["—", "—", "—", "—", "—", "—", "—", "—", "—"] },
        { label: "Inspire Sonoran Desert", values: ["—", "—", "—", "—", "—", "—", "—", "—", "—"] },
        { label: "Journey Church", values: ["—", "—", "—", "—", "—", "—", "—", "—", "—"] },
        { label: "Knoxville", values: ["—", "—", "—", "—", "—", "—", "—", "—", "—"] },
        { label: "Longmont II", values: ["—", "—", "—", "—", "—", "—", "—", "—", "—"] },
        { label: "Nexton", values: ["—", "—", "—", "—", "—", "—", "—", "—", "—"] },
        { label: "Parker II", values: ["—", "—", "—", "—", "—", "—", "—", "—", "—"] },
        { label: "Pleasant Grove", values: ["—", "—", "—", "—", "—", "—", "—", "—", "—"] },
        { label: "Powers Place", values: ["—", "—", "—", "—", "—", "—", "—", "—", "—"] },
        { label: "Vista Highlands", values: ["—", "—", "—", "—", "—", "—", "—", "—", "—"] },
        { label: "Uptown Commons", values: ["—", "—", "—", "—", "—", "—", "—", "—", "—"] },
        { total: true, label: "Portfolio Total / Avg", values: ["$6,220,828.00", "$9,303,351.65", "$3,082,523.65", "$170,767.32", "$320,396.51", "79%", "$4,139,116.33", "$2,332,323.09", "$2,711,830.00"] }
      ]
    },

    coverCACVarianceOverview: {
      badge: "As of 2/17/2026",
      columns: ["Project", "Current CAC", "Prior CAC", "CAC Variance", "Current Final CO Date", "Prior Final CO Date", "CO Date Variance", "Buyout %"],
      rows: [
        { label: "Aspire on 10th", values: ["—", "—", "—", "—", "—", "—", "—", "—", "—"] },
        { label: "Banyan", values: ["—", "—", "—", "—", "—", "—", "—", "—", "—"] },
        { label: "Deleware Powers Place", values: ["—", "—", "—", "—", "—", "—", "—", "—", "—"] },
        { label: "County Line", values: ["—", "—", "—", "—", "—", "—", "—", "—", "—"] },
        { label: "Garrett Mesa", values: ["$45,256,395.49", "$45,253,335.49", "$3,060.00", "4/2/2026", "4/2/2026", "0", "100%"] },
        { label: "Fillmore", values: ["—", "—", "—", "—", "—", "—", "—", "—", "—"] },
        { label: "Flying Horse", values: ["—", "—", "—", "—", "—", "—", "—", "—", "—"] },
        { label: "FM Gateway", values: ["—", "—", "—", "—", "—", "—", "—", "—", "—"] },
        { label: "Forum II", values: ["—", "—", "—", "—", "—", "—", "—", "—", "—"] },
        { label: "Havana", values: ["—", "—", "—", "—", "—", "—", "—", "—", "—"] },
        { label: "Inspire Sonoran Desert", values: ["—", "—", "—", "—", "—", "—", "—", "—", "—"] },
        { label: "Journey Church", values: ["—", "—", "—", "—", "—", "—", "—", "—", "—"] },
        { label: "Knoxville", values: ["—", "—", "—", "—", "—", "—", "—", "—", "—"] },
        { label: "Longmont II", values: ["—", "—", "—", "—", "—", "—", "—", "—", "—"] },
        { label: "Nexton", values: ["—", "—", "—", "—", "—", "—", "—", "—", "—"] },
        { label: "Parker II", values: ["—", "—", "—", "—", "—", "—", "—", "—", "—"] },
        { label: "Pleasant Grove", values: ["—", "—", "—", "—", "—", "—", "—", "—", "—"] },
        { label: "Powers Place", values: ["—", "—", "—", "—", "—", "—", "—", "—", "—"] },
        { label: "Vista Highlands", values: ["—", "—", "—", "—", "—", "—", "—", "—", "—"] },
        { label: "Uptown Commons", values: ["—", "—", "—", "—", "—", "—", "—", "—", "—"] },
        { total: true, label: "Portfolio Total / Avg", values: ["$45,256,395.49", "$45,253,335.49", "$3,060.00", "4/2/2026", "4/2/2026", "0", "100%"] }
      ]
    },

    coverPortfolioLeasingUpdate: {
      badge: "As of 2/17/2026",
      columns: ["Project", "Budgeted Occupancy", "Current Occupancy", "Trending Occupancy", "Applications Completed", "Leases Signed"],
      rows: [
        { section: "Updated Weekly" },
        { label: "Garrett Mesa", values: ["4.00%", "2.43%", "2.83%", "4", "3"] },
        { label: "FM Gateway", values: ["—", "—", "—", "—", "—"] },
        { label: "Forum II", values: ["—", "—", "—", "—", "—"] },
        { label: "Knoxville", values: ["—", "—", "—", "—", "—"] },
        { label: "Longmont II", values: ["—", "—", "—", "—", "—"] },
        { label: "Uptown Commons", values: ["—", "—", "—", "—", "—"] },
        { total: true, label: "Portfolio Total / Avg", values: ["4.00%", "2.43%", "2.83%", "4", "3"] }
      ]
    },

    renderings: [
      "https://static.wixstatic.com/media/4f7dd4_1e48e68112824b76b71f1fa47a8b43bf~mv2.png",
      "https://static.wixstatic.com/media/4f7dd4_5f30edd663e04eda872bdb5db4152cce~mv2.png",
      "https://static.wixstatic.com/media/4f7dd4_489ff7a8f3ad48c8a4a4409c5ea6607d~mv2.png"
    ],
    mapUrl: "https://www.google.com/maps/d/u/0/embed?mid=19g9mO03d0QsNHdzPcYec8Q9HymE_fPc&ehbc=2E312F&noprof=1"
  },

  garrettmesa: {
    name: "Garrett Mesa",
    state: "Arizona",
    location: "Mesa, Arizona",
    highlights: [
],

    weeklyCACNotes: [
      "Add weekly CAC commentary here.",
      "Add weekly CAC commentary here.",
      "Add weekly CAC commentary here."
    ],

    smartPMKeyMilestones: {
      badge: "As of 2/17/2026",
      columns: ["Milestone", "Current Date", "Prior Date", "Variance", "Notes"],
      rows: [
        { label: "Example Milestone", values: ["2/29/2028", "2/29/2028", "0", "—"] },
        { label: "Example Milestone", values: ["2/29/2028", "2/29/2028", "0", "—"] },
        { label: "Example Milestone", values: ["2/29/2028", "2/29/2028", "0", "—"] },
        { label: "Example Milestone", values: ["2/29/2028", "2/29/2028", "0", "—"] },
        { label: "Example Milestone", values: ["2/29/2028", "2/29/2028", "0", "—"] }
      ]
    },

    assetManagementTracker: {
      badge: "As of 2/17/2026",
      columns: ["Category", "Owner", "Status", "Next Action", "Due Date"],
      rows: [
        { label: "Example Item", values: ["TBD", "TBD", "Follow up", "2/29/2026"] },
        { label: "Example Item", values: ["TBD", "TBD", "Follow up", "2/29/2026"] },
        { label: "Example Item", values: ["TBD", "TBD", "Follow up", "2/29/2026"] },
        { label: "Example Item", values: ["TBD", "TBD", "Follow up", "2/29/2026"] },
        { label: "Example Item", values: ["TBD", "TBD", "Follow up", "2/29/2026"] },
        { label: "Example Item", values: ["TBD", "TBD", "Follow up", "2/29/2026"] },
        { label: "Example Item", values: ["TBD", "TBD", "Follow up", "2/29/2026"] },
        { label: "Example Item", values: ["TBD", "TBD", "Follow up", "2/29/2026"] },
        { label: "Example Item", values: ["TBD", "TBD", "Follow up", "2/29/2026"] },
        { label: "Example Item", values: ["TBD", "TBD", "Follow up", "2/29/2026"] },
        { label: "Example Item", values: ["TBD", "TBD", "Follow up", "2/29/2026"] },
        { label: "Example Item", values: ["TBD", "TBD", "Follow up", "2/29/2026"] },
        { label: "Example Item", values: ["TBD", "TBD", "Follow up", "2/29/2026"] },
        { label: "Example Item", values: ["TBD", "TBD", "Follow up", "2/29/2026"] },
        { label: "Example Item", values: ["TBD", "TBD", "Follow up", "2/29/2026"] },
        { label: "Example Item", values: ["TBD", "TBD", "Follow up", "2/29/2026"] },
        { label: "Example Item", values: ["TBD", "TBD", "Follow up", "2/29/2026"] },
        { label: "Example Item", values: ["TBD", "TBD", "Follow up", "2/29/2026"] }
      ]
    },

    leasingActivity: {
      rows: [
        { label: "Average SQFT", key: "avg_square_feet", format: "number2" },
        { label: "Average Market Rent", key: "avg_market_rent", format: "currency2" },
        { label: "Average Scheduled Rent", key: "scheduled_rent", format: "currency2" },
        { divider: true },

        { label: "Units", key: "total_units", format: "int" },
        { label: "Rentable Units", key: "total_rentable_units", format: "int" },
        { label: "Occupied Units", key: "occupied_units", format: "int" },
        { label: "Vacant Units", key: "vacant_units", format: "int" },
        { label: "Available Units", key: "available_units", format: "int" },
        { divider: true },

        { label: "Occupied No Notice", key: "occupied_no_notice_units", format: "int" },
        { label: "Notice Rented", key: "notice_rented_units", format: "int" },
        { label: "Notice Unrented", key: "notice_unrented_units", format: "int" },
        { label: "Vacant Rented", key: "vacant_rented_units", format: "int" },
        { label: "Vacant Unrented", key: "vacant_unrented_units", format: "int" },
        { divider: true },

        { label: "Occupied %", key: "percent_occupied", format: "percent2" },
        { label: "Leased %", key: "percent_leased", format: "percent2" },
        { label: "Trend %", key: "avg_not_exposed_leased_units", format: "percent2" },
        { label: "Exposure %", key: "avg_exposure", format: "percent2" }
      ],
      refreshMs: 15 * 60 * 1000,
    },

    entrataBoxScore: {
      requestId: 15,
      methodName: "getReportData",
      methodVersion: "r2",
      params: {
        reportName: "box_score",
        reportVersion: "3.9",
        filters: {
          property_group_ids: [100107077],
          period: {
            period_type: "lastwk",
            "week-start": "5",
            allow_future_periods: true
          },
          summarize_by: "unit_type",
          consolidate_by: "no_consolidation",
          data_set: ""
        }
      },
      basicAuth: {
        username: "username",
        password: "password"
      }
    },

    projectHealth: {
      unitsBadge: "As of 2/17/2026",
      columns: ["Charge Type", "Original Contract", "Change Orders", "Revised Bank SOV", "Cost / Risk", "Current $ Remaining"],
      rows: [
        { section: "Construction" },
        { label: "Profit", values: ["$2,976,192.00", "—", "$2,976,192.00", "—", "$2,976,192.00"] },
        { label: "Do Not Touch", values: ["$4,403,285.19", "$399,779.60", "$4,803,064.79", "—", "$4,803,064.79"] },
        { label: "Contingency", values: ["$2,204,675.00", "—", "$2,204,675.00", "—", "$2,204,675.00"] },
        { label: "GC Risk", values: ["—", "—", "—", "$484,753.97", "$484,753.97"], muted: true },
        { label: "General Conditions", values: ["$3,175,000.00", "—", "$3,175,000.00", "($3,196,438.88)", "($21,438.88)"] },
        { subtotal: true, label: "Construction Total", values: ["$12,759,152.19", "$399,779.60", "$13,158,931.79", "($2,711,684.91)", "$10,447,246.88"] },
        { divider: true },
        { section: "Companies" },
        { label: "Development Fee", values: ["$3,942,527.00", "—", "$3,942,527.00", "—", "$3,942,527.00"] },
        { label: "Soft Costs", values: ["$16,807,723.00", "—", "$16,807,723.00", "($16,807,723.00)", "—"] },
        { label: "Interest Reserve", values: ["$4,571,376.00", "—", "$4,571,376.00", "($4,571,376.00)", "—"] },
        { subtotal: true, label: "Companies Total", values: ["$25,321,626.00", "—", "$25,321,626.00", "($21,379,099.00)", "$3,942,527.00"] },
        { divider: true },
        { total: true, label: "Grand Total", values: ["$38,080,778.19", "$399,779.60", "$38,480,557.79", "($24,090,783.91)", "$14,389,773.88"] }
      ]
    },

    cashFlow: {
      asOfBadge: "As of Dec",
      columns: ["Charge Type", "Revised Bank SOV", "Amount Billed", "% Billed", "Balance to Bill"],
      rows: [
        { section: "Construction" },
        { label: "Fee", values: ["$2,976,192.00", "$133,885.76", "4%", "$2,842,306.24"] },
        { label: "Do Not Touch", values: ["$4,803,064.79", "—", "0%", "$4,803,064.79"] },
        { label: "Contingency", values: ["$2,204,675.00", "—", "0%", "$2,204,675.00"] },
        { label: "GC Risk", values: ["—", "—", "0%", "—"], muted: true },
        { label: "General Conditions", values: ["$3,175,000.00", "$142,850.00", "4%", "$3,032,150.00"] },
        { subtotal: true, label: "Construction Total", values: ["$10,954,256.79", "$276,735.76", "3%", "$10,677,521.03"] },
        { divider: true },
        { section: "Companies" },
        { label: "Development Fee", values: ["$2,907,612.00", "$792,985.00", "27%", "$2,114,627.00"] },
        { label: "Soft Costs", values: ["—", "—", "—", "—"], muted: true },
        { label: "Interest Reserve", values: ["—", "—", "—", "—"], muted: true },
        { subtotal: true, label: "Companies Total", values: ["$2,907,612.00", "$792,985.00", "27%", "$2,114,627.00"] },
        { divider: true },
        { total: true, label: "Grand Total", values: ["$13,861,868.79", "$1,069,720.76", "8%", "$12,792,148.03"] }
      ]
    },

    projectScheduleUpdate: {
      badge: "Approved 2/17/26",
      columns: ["Cost Code", "Division", "CAC Variance", "Detail Description", "Committee Request"],
      rows: [
        { label: "12-3640.S", values: ["Countertops", "($103,514.20)", "Countertop buyout savings", "29"] },
        { label: "13-1100", values: ["Pool", "($19,904.00)", "Buyout savings with AquaVision", "32"] },
        { total: true, label: "Grand Total", values: ["", "($123,418.20)", "", ""] }
      ]
    },

    scheduleVarianceUpdate: {
      badge: "Approved 2/17/26",
      columns: ["Building/Amenity", "Current Date", "Previous Date", "Variance"],
      rows: [
        { label: "Clubhouse Turnover", values: ["12/16/2026", "12/16/2026", "0"] },
        { label: "Building 1 - TCO", values: ["10/26/2027", "10/26/2027", "0"] },
        { label: "Final CO", values: ["2/29/2028", "2/29/2028", "0"] }
      ]
    },

    renderings: [
      "https://static.wixstatic.com/media/4f7dd4_b8e32391bceb4e59b327f3fc09e2a930~mv2.png",
      "https://static.wixstatic.com/media/4f7dd4_61f93fdbb7004815b0c56a7e0aacf182~mv2.png"
    ],

    mapUrl: "https://www.google.com/maps?q=33.391203,-111.727545&output=embed",

    droneDeploy: {
      projectId: "Project:66b0ce0d79e6b866bc965f27",
      photoGroupName: "Photo Group #1"
    }
  },
};

const stateSelector = document.getElementById("stateSelector");
const selector = document.getElementById("projectSelector");
const content = document.getElementById("projectContent");

/* Date formatter: M/D/YYYY */
function getTodayMDY() {
  return new Date().toLocaleDateString("en-US");
}

/* Format ISO to M/D/YYYY */
function formatISOToMDY(iso) {
  if (!iso) return "";
  const d = new Date(iso);
  if (isNaN(d.getTime())) return "";
  return d.toLocaleDateString("en-US");
}

/* Get unique states */
let states = [...new Set(Object.values(projects).map(p => p.state).filter(Boolean))];
states.sort((a, b) => a.localeCompare(b));

/* Populate state dropdown */
stateSelector.innerHTML =
  `<option value="all" selected>All States</option>` +
  states.map(state => `<option value="${state}">${state}</option>`).join("");

/* Populate project dropdown */
function populateProjectDropdown(filteredProjects, selectedState = "all") {
  selector.innerHTML = "";

  if (selectedState === "all") {
    const fullOption = document.createElement("option");
    fullOption.value = "tgcportfolio";
    fullOption.textContent = "Full TGC Portfolio";
    selector.appendChild(fullOption);
  }

  filteredProjects.forEach(([key, project]) => {
    if (key !== "tgcportfolio") {
      const option = document.createElement("option");
      option.value = key;
      option.textContent = project.name;
      selector.appendChild(option);
    }
  });
}

/* Initial full project list */
populateProjectDropdown(Object.entries(projects));

/* Filter projects by state */
stateSelector.addEventListener("change", e => {
  const selectedState = e.target.value;
  let filteredProjects = Object.entries(projects);

  if (selectedState !== "all") {
    filteredProjects = filteredProjects.filter(([_, project]) => project.state === selectedState);
  }

  populateProjectDropdown(filteredProjects, selectedState);

  const firstProjectKey =
    filteredProjects.length > 0
      ? filteredProjects[0][0]
      : (selectedState === "all" ? "tgcportfolio" : null);

  if (firstProjectKey) renderProject(firstProjectKey);
});

/* --- Render helpers --- */
let slideIndex = 1;

function escapeHtml(str) {
  if (str === null || str === undefined) return "";
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

/* value classifiers */
function isParenNegative(val) {
  if (val === null || val === undefined) return false;
  const s = String(val).trim();
  return /^\(\s*[^)]+\s*\)$/.test(s) && /\d/.test(s);
}

function isPositiveNumberish(val) {
  if (val === null || val === undefined) return false;
  const s = String(val).trim();
  if (!s || s === "—" || s === "-" || s.toLowerCase() === "n/a") return false;
  if (isParenNegative(s)) return false;
  if (/^-/.test(s)) return false;
  return /\d/.test(s);
}

/* parse money-ish strings like "$876K", "($1.2M)", "$3,066,666.67" */
function parseMoneyishToNumber(val) {
  if (val === null || val === undefined) return null;
  let s = String(val).trim();
  if (!s) return null;

  let negative = false;
  if (isParenNegative(s)) {
    negative = true;
    s = s.replace(/^\(\s*/,"").replace(/\s*\)$/,"");
  }
  if (/^-/.test(s)) {
    negative = true;
    s = s.replace(/^-+/,"");
  }

  s = s.replace(/\$/g, "").replace(/,/g, "").trim();

  let mult = 1;
  const suffixMatch = s.match(/([kmb])$/i);
  if (suffixMatch) {
    const suf = suffixMatch[1].toLowerCase();
    mult = suf === "k" ? 1e3 : (suf === "m" ? 1e6 : 1e9);
    s = s.slice(0, -1).trim();
  }

  const num = parseFloat(s);
  if (!isFinite(num)) return null;

  const out = num * mult;
  return negative ? -out : out;
}

/* ✅ parse generic numbers (for things like "0", "14", "-7", "(12)") */
function parseGenericToNumber(val) {
  if (val === null || val === undefined) return null;
  let s = String(val).trim();
  if (!s) return null;
  if (s === "—" || s === "-" || s.toLowerCase() === "n/a") return null;

  let negative = false;
  if (isParenNegative(s)) {
    negative = true;
    s = s.replace(/^\(\s*/,"").replace(/\s*\)$/,"");
  }
  if (/^-/.test(s)) {
    negative = true;
    s = s.replace(/^-+/,"");
  }

  s = s.replace(/,/g, "").replace(/%/g, "").trim();

  const num = parseFloat(s);
  if (!isFinite(num)) return null;
  return negative ? -num : num;
}

/* Scrollbar padding helper (adds class ONLY when overflow exists) */
function updateExcelScrollbarPadding(scope = document) {
  const wraps = scope.querySelectorAll(".excel-table-wrap");
  wraps.forEach(wrap => {
    const hasXScroll = wrap.scrollWidth > (wrap.clientWidth + 1);
    wrap.classList.toggle("has-x-scroll", hasXScroll);
  });
}

/* Keep it updated on resize + element resize */
let __excelRO;
function attachExcelWrapObservers(scope = document) {
  if (!("ResizeObserver" in window)) return;

  if (!__excelRO) {
    __excelRO = new ResizeObserver(() => updateExcelScrollbarPadding(scope));
  }

  scope.querySelectorAll(".excel-table-wrap").forEach(el => __excelRO.observe(el));
}

/* ✅ internal navigation from cover-table project links */
function navigateToProject(projectKey, scrollToTop = true) {
  if (!projects[projectKey]) return;

  if (stateSelector) {
    stateSelector.value = "all";
    stateSelector.dispatchEvent(new Event("change", { bubbles: true }));
  }

  if (selector) {
    let opt = selector.querySelector(`option[value="${projectKey}"]`);
    if (!opt) {
      opt = new Option(projects[projectKey].name || projectKey, projectKey);
      selector.appendChild(opt);
    }
    selector.value = projectKey;
  }

  renderProject(projectKey);
  if (scrollToTop) window.scrollTo({ top: 0, behavior: "smooth" });
}

/* cover-table variance coloring + clickable Garrett Mesa */
function renderExcelTable(targetTableEl, config) {
  if (!targetTableEl) return;

  if (!config || !config.columns || !Array.isArray(config.columns) || config.columns.length === 0) {
    targetTableEl.innerHTML = "";
    return;
  }

  const cols = config.columns.slice();
  const numericCols = cols.length - 1;

  const isCoverTable = /^cover/i.test(targetTableEl.id || "");

  const norm = (s) => String(s || "").trim().toLowerCase();
  const varianceColIdxs = new Set(
    cols
      .map((c, i) => ({ c: norm(c), i }))
      .filter(({ c }) => c === "total variance" || c === "cac variance" || c === "co date variance")
      .map(({ i }) => i)
  );

  const thead = `
    <thead>
      <tr>
        ${cols.map((c, i) => `<th ${i > 0 ? 'style="text-align:right;"' : ""}>${escapeHtml(c)}</th>`).join("")}
      </tr>
    </thead>
  `;

  const rows = Array.isArray(config.rows) ? config.rows : [];
  const tbodyRows = rows.map(r => {
    if (r && r.divider) return `<tr class="excel-divider"><td colspan="${cols.length}"></td></tr>`;
    if (r && typeof r.section === "string") return `<tr class="excel-section-header"><td colspan="${cols.length}">${escapeHtml(r.section)}</td></tr>`;

    const isTotal = !!(r && r.total);
    const isSubtotal = !!(r && r.subtotal);
    const isMuted = !!(r && r.muted);

    const labelText = (r && r.label) ? String(r.label).trim() : "";
    const labelSafe = escapeHtml(labelText);

    const labelCellHtml =
      (isCoverTable && /^garrett mesa$/i.test(labelText))
        ? `<a href="#" class="excel-link" data-project="garrettmesa">${labelSafe}</a>`
        : labelSafe;

    const values = (r && Array.isArray(r.values)) ? r.values : [];
    const padded = values.slice(0, numericCols);
    while (padded.length < numericCols) padded.push("—");

    const rowClass = (isTotal ? "excel-total" : (isSubtotal ? "excel-subtotal" : ""));
    const isTotalsRow = (isTotal || isSubtotal);
    const greenEligibleLabel = /^(Construction Total|Companies Total|Grand Total)$/i.test(labelText);

    return `
      <tr class="${rowClass}">
        <td class="excel-row-label ${isMuted ? "excel-muted" : ""}">${labelCellHtml}</td>
        ${padded.map((v, idx) => {
          const colIndex = idx + 1;
          const classList = ["excel-number"];
          if (isMuted) classList.push("excel-muted");

          const parenNeg = isParenNegative(v);
          if (parenNeg) classList.push("is-negative");

          if (isTotalsRow && greenEligibleLabel && isPositiveNumberish(v)) classList.push("total-positive");

          if (varianceColIdxs.has(colIndex)) {
            let n = parseMoneyishToNumber(v);
            if (typeof n !== "number") n = parseGenericToNumber(v);

            if (typeof n === "number") {
              if (n < 0) {
                if (!classList.includes("is-negative")) classList.push("is-negative");
              } else if (n > 0) {
                classList.push("is-positive");
              }
            }
          }

          return `<td class="${classList.join(" ")}" title="${escapeHtml(v)}">${escapeHtml(v)}</td>`;
        }).join("")}
      </tr>
    `;
  }).join("");

  targetTableEl.innerHTML = thead + `<tbody>${tbodyRows}</tbody>`;
}

function setCardVisibility(cardId, isVisible) {
  const el = document.getElementById(cardId);
  if (!el) return;
  el.style.display = isVisible ? "flex" : "none";
}

/* cover-table link click */
content.addEventListener("click", (e) => {
  const a = e.target.closest && e.target.closest("a.excel-link[data-project]");
  if (!a) return;
  e.preventDefault();

  const key = a.getAttribute("data-project");
  if (key) navigateToProject(key, true);
});

/* ============================================================
   ✅ Entrata Helpers (Box Score Totals)
   ============================================================ */
const __entrataCache = new Map();
let __entrataIntervalHandle = null;

function safeNumber(v) {
  const n = Number(v);
  return Number.isFinite(n) ? n : 0;
}

function formatInt(n) {
  if (n === null || n === undefined) return "—";
  const x = Number(n);
  if (!Number.isFinite(x)) return "—";
  return Math.round(x).toLocaleString("en-US");
}

function formatNumber2(n) {
  if (n === null || n === undefined) return "—";
  const x = Number(n);
  if (!Number.isFinite(x)) return "—";
  return x.toLocaleString("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function formatCurrency2(n) {
  if (n === null || n === undefined) return "—";
  const x = Number(n);
  if (!Number.isFinite(x)) return "—";
  return x.toLocaleString("en-US", { style: "currency", currency: "USD", minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function formatPercent2(frac) {
  if (frac === null || frac === undefined) return "—";
  const x = Number(frac);
  if (!Number.isFinite(x)) return "—";
  return `${(x * 100).toFixed(2)}%`;
}

function buildEntrataRpcPayload(project) {
  const cfg = project?.entrataBoxScore;
  if (!cfg) return null;

  return {
    requestId: cfg.requestId,
    method: {
      name: cfg.methodName,
      version: cfg.methodVersion,
      params: cfg.params
    }
  };
}

function getEntrataBasicAuthHeader(project) {
  const u = project?.entrataBoxScore?.basicAuth?.username || "";
  const p = project?.entrataBoxScore?.basicAuth?.password || "";
  if (!u || !p) return null;
  const token = btoa(`${u}:${p}`);
  return `Basic ${token}`;
}

async function fetchEntrataBoxScore(project) {
  const payload = buildEntrataRpcPayload(project);
  if (!payload) throw new Error("Entrata payload missing.");

  const res = await fetch("https://eg-executive-dashboard.bshives.workers.dev/entrata", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  const text = await res.text();
  let json;
  try { json = JSON.parse(text); }
  catch { throw new Error(`Entrata Worker returned non-JSON: ${text.slice(0, 200)}`); }

  if (!res.ok) {
    throw new Error(`Entrata Worker error: ${json?.message || text.slice(0, 200)}`);
  }

  return json;
}


function extractAvailabilityRows(entrataJson) {
  const availability =
    entrataJson?.response?.result?.[0]?.reportData?.availability;

  return Array.isArray(availability) ? availability : [];
}

function computeBoxScoreTotals(availabilityRows) {
  const totals = {
    total_units: 0,
    excluded_units: 0,
    total_rentable_units: 0,
    occupied_units: 0,
    vacant_units: 0,
    available_units: 0,
    occupied_no_notice_units: 0,
    notice_rented_units: 0,
    notice_unrented_units: 0,
    vacant_rented_units: 0,
    vacant_unrented_units: 0,

    avg_square_feet: null,
    avg_market_rent: null,
    scheduled_rent: null,

    percent_occupied: null,
    percent_leased: null,
    avg_not_exposed_leased_units: null,
    avg_exposure: null
  };

  let wUnits = 0;
  let wRentable = 0;

  let sumSqFt = 0;
  let sumMarket = 0;
  let sumScheduled = 0;

  let sumPctOcc = 0;
  let sumPctLeased = 0;
  let sumPctTrend = 0;
  let sumPctExposure = 0;

  availabilityRows.forEach(r => {
    const tu = safeNumber(r.total_units);
    const tr = safeNumber(r.total_rentable_units);

    totals.total_units += tu;
    totals.excluded_units += safeNumber(r.excluded_units);
    totals.total_rentable_units += tr;
    totals.occupied_units += safeNumber(r.occupied_units);
    totals.vacant_units += safeNumber(r.vacant_units);
    totals.available_units += safeNumber(r.available_units);
    totals.occupied_no_notice_units += safeNumber(r.occupied_no_notice_units);
    totals.notice_rented_units += safeNumber(r.notice_rented_units);
    totals.notice_unrented_units += safeNumber(r.notice_unrented_units);
    totals.vacant_rented_units += safeNumber(r.vacant_rented_units);
    totals.vacant_unrented_units += safeNumber(r.vacant_unrented_units);

    if (tu > 0) {
      wUnits += tu;
      sumSqFt += safeNumber(r.avg_square_feet) * tu;
      sumMarket += safeNumber(r.avg_market_rent) * tu;
      sumScheduled += safeNumber(r.scheduled_rent) * tu;
    }

    if (tr > 0) {
      wRentable += tr;
      sumPctOcc += safeNumber(r.percent_occupied) * tr;
      sumPctLeased += safeNumber(r.percent_leased) * tr;
      sumPctTrend += safeNumber(r.avg_not_exposed_leased_units) * tr;
      sumPctExposure += safeNumber(r.avg_exposure) * tr;
    }
  });

  if (wUnits > 0) {
    totals.avg_square_feet = sumSqFt / wUnits;
    totals.avg_market_rent = sumMarket / wUnits;
    totals.scheduled_rent = sumScheduled / wUnits;
  }

  if (wRentable > 0) {
    totals.percent_occupied = sumPctOcc / wRentable;
    totals.percent_leased = sumPctLeased / wRentable;
    totals.avg_not_exposed_leased_units = sumPctTrend / wRentable;
    totals.avg_exposure = sumPctExposure / wRentable;
  } else if (totals.total_rentable_units > 0) {
    totals.percent_occupied = totals.occupied_units / totals.total_rentable_units;
    totals.percent_leased = (totals.occupied_units + totals.vacant_rented_units + totals.notice_rented_units) / totals.total_rentable_units;
    totals.avg_exposure = 1 - (totals.percent_leased || 0);
    totals.avg_not_exposed_leased_units = totals.percent_leased;
  }

  return totals;
}

function renderLeasingActivityTable(tableEl, project, totalsOrNull) {
  if (!tableEl) return;

  const cfg = project?.leasingActivity;
  const rows = Array.isArray(cfg?.rows) ? cfg.rows : [];

  tableEl.innerHTML = "";

  rows.forEach(r => {
    if (r && r.divider) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<th class="excel-muted"> </th><td class="excel-muted"> </td>`;
      tableEl.appendChild(tr);
      return;
    }

    const label = r.label || "";
    const key = r.key;

    let raw = totalsOrNull ? totalsOrNull[key] : null;
    let val = "—";

    switch (r.format) {
      case "int": val = formatInt(raw); break;
      case "number2": val = formatNumber2(raw); break;
      case "currency2": val = formatCurrency2(raw); break;
      case "percent2": val = formatPercent2(raw); break;
      default:
        val = (raw === null || raw === undefined) ? "—" : String(raw);
        break;
    }

    const tr = document.createElement("tr");
    tr.innerHTML = `<th>${escapeHtml(label)}</th><td>${escapeHtml(val)}</td>`;
    tableEl.appendChild(tr);
  });
}

/* ============================================================
   ✅ DroneDeploy GraphQL helpers (unchanged)
   ============================================================ */
async function ddGraphQL(query, variables = {}) {
  const res = await fetch("https://eg-executive-dashboard.bshives.workers.dev/drone", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ query, variables })
  });

  const text = await res.text();
  let json;
  try { json = JSON.parse(text); }
  catch { throw new Error(`Non-JSON response from Worker: ${text.slice(0, 200)}`); }

  if (!res.ok) {
    throw new Error(`DroneDeploy Worker error: ${json?.errors?.[0]?.message || text.slice(0, 200)}`);
  }

  return json.data;
}


async function ddGetLatestPhotoGroupPlanId(projectId, photoGroupName) {
  const q = `
    query GetProjectPlans($projectId: ID!) {
      project(id: $projectId) {
        id
        name
        plans(first: 100) {
          edges {
            node {
              id
              name
              __typename
              dateCreation
            }
          }
        }
      }
    }
  `;

  const data = await ddGraphQL(q, { projectId });

  const edges = data?.project?.plans?.edges || [];
  const candidates = edges
    .map(e => e?.node)
    .filter(n => n && n.__typename === "ProgressPhotoPlan" && String(n.name).trim() === String(photoGroupName).trim());

  if (!candidates.length) return null;

  const withDates = candidates
    .map(n => ({ id: n.id, date: n.dateCreation ? new Date(n.dateCreation).getTime() : null }))
    .sort((a, b) => (b.date || 0) - (a.date || 0));

  return withDates[0]?.id || null;
}

async function ddGetProgressPhotoPlanPhotos(planId, first = 30) {
  const q = `
    query GetProgressPhotos($planId: ID!, $first: Int!) {
      node(id: $planId) {
        __typename
        ... on ProgressPhotoPlan {
          id
          name
          photos(first: $first) {
            edges {
              node {
                url
                dateCreation
              }
            }
          }
        }
      }
    }
  `;
  const data = await ddGraphQL(q, { planId, first });

  const edges = data?.node?.photos?.edges || [];
  const photos = edges
    .map(e => e?.node)
    .filter(p => p && p.url);

  const latestMs = photos.reduce((max, p) => {
    const t = p.dateCreation ? new Date(p.dateCreation).getTime() : 0;
    return t > max ? t : max;
  }, 0);

  return {
    photos,
    latestDateISO: latestMs ? new Date(latestMs).toISOString() : null
  };
}

const __ddCache = {
  latestPlan: new Map(),
  photosByPlan: new Map()
};

async function ddLoadLatestGalleryForProject(project, renderingDiv) {
  const dd = project.droneDeploy;
  if (!dd || !dd.projectId || !dd.photoGroupName) return null;

  const cacheKey = `${dd.projectId}|${dd.photoGroupName}`;
  let planId = null;

  const cachedPlan = __ddCache.latestPlan.get(cacheKey);
  if (cachedPlan && (Date.now() - cachedPlan.ts) < (DRONEDEPLOY_REFRESH_MS / 2)) {
    planId = cachedPlan.planId;
  } else {
    planId = await ddGetLatestPhotoGroupPlanId(dd.projectId, dd.photoGroupName);
    __ddCache.latestPlan.set(cacheKey, { planId, ts: Date.now() });
  }

  if (!planId) return null;

  const cachedPhotos = __ddCache.photosByPlan.get(planId);
  let photoPayload;
  if (cachedPhotos && (Date.now() - cachedPhotos.ts) < (DRONEDEPLOY_REFRESH_MS / 2)) {
    photoPayload = cachedPhotos;
  } else {
    const out = await ddGetProgressPhotoPlanPhotos(planId, 30);
    photoPayload = { ...out, ts: Date.now() };
    __ddCache.photosByPlan.set(planId, photoPayload);
  }

  return {
    planId,
    photos: photoPayload.photos,
    latestDateISO: photoPayload.latestDateISO
  };
}

function renderGallery(renderingDiv, imageUrls, badgeText = "", statusText = "") {
  const safeUrls = Array.isArray(imageUrls) ? imageUrls.filter(Boolean) : [];

  renderingDiv.innerHTML = `
    ${safeUrls.map((img, i) => `
      <div class="gallery-slide fade">
        <img src="${img}" alt="Gallery Image ${i + 1}">
      </div>
    `).join("")}
    <div class="gallery-badge" id="galleryBadge"></div>
    <div class="gallery-status" id="galleryStatus"></div>
    <a class="prev">&#10094;</a>
    <a class="next">&#10095;</a>
  `;

  const badgeEl = renderingDiv.querySelector("#galleryBadge");
  if (badgeEl) {
    if (badgeText) {
      badgeEl.textContent = badgeText;
      badgeEl.style.display = "inline-block";
    } else {
      badgeEl.style.display = "none";
    }
  }

  const statusEl = renderingDiv.querySelector("#galleryStatus");
  if (statusEl) {
    if (statusText) {
      statusEl.textContent = statusText;
      statusEl.style.display = "inline-block";
    } else {
      statusEl.style.display = "none";
    }
  }

  slideIndex = 1;
  showSlides(slideIndex);

  const prev = renderingDiv.querySelector(".prev");
  const next = renderingDiv.querySelector(".next");
  if (prev) prev.addEventListener("click", () => plusSlides(-1));
  if (next) next.addEventListener("click", () => plusSlides(1));
}

let __ddIntervalHandle = null;

function renderBulletsIntoList(listEl, items) {
  if (!listEl) return;
  listEl.innerHTML = "";
  (items || []).forEach(t => {
    const li = document.createElement("li");
    li.textContent = t;
    listEl.appendChild(li);
  });
}

/* ============================================================
   SmartPM loader (calls your Worker endpoint and falls back to static)
   - Uses the existing table rendering and badge behavior.
   ============================================================ */
async function loadSmartPMFromWorkerOrFallback(project, smTable, smBadge) {
  // Worker endpoint used elsewhere in this dashboard
  const WORKER_SMARTPM_URL = "https://eg-executive-dashboard.bshives.workers.dev/smartpm";

  // If project has no SmartPM config at all, clear UI and return
  const fallbackCfg = project?.smartPMKeyMilestones || null;

  try {
    const res = await fetch(WORKER_SMARTPM_URL, {
      method: "GET",
      headers: { "Content-Type": "application/json" }
    });

    const text = await res.text();
    let json;
    try { json = JSON.parse(text); } catch { json = null; }

    if (!res.ok || !json) {
      // Worker returned non-OK or non-JSON — fall back
      if (fallbackCfg) {
        if (smBadge && fallbackCfg.badge) { smBadge.style.display = "inline-block"; smBadge.textContent = fallbackCfg.badge; }
        else if (smBadge) smBadge.style.display = "none";
        renderExcelTable(smTable, fallbackCfg);
      } else {
        if (smTable) smTable.innerHTML = "";
        if (smBadge) smBadge.style.display = "none";
      }
      return;
    }

    // Attempt to normalize common SmartPM shapes into { columns: [], rows: [] }
    // If the Worker returns an object with data/items/results, try to find an array of milestones.
    let items = null;

    // Common patterns: json.data, json.items, json.results, json
    if (Array.isArray(json)) {
      items = json;
    } else if (Array.isArray(json.items)) {
      items = json.items;
    } else if (Array.isArray(json.results)) {
      items = json.results;
    } else if (Array.isArray(json.data)) {
      items = json.data;
    } else if (Array.isArray(json.rows)) {
      items = json.rows;
    } else if (json && typeof json === "object") {
      // Try to find the first array-valued property that looks like rows
      for (const k of Object.keys(json)) {
        if (Array.isArray(json[k])) {
          items = json[k];
          break;
        }
      }
    }

    // If we couldn't find an array, fall back to static config
    if (!Array.isArray(items)) {
      if (fallbackCfg) {
        if (smBadge && fallbackCfg.badge) { smBadge.style.display = "inline-block"; smBadge.textContent = fallbackCfg.badge; }
        else if (smBadge) smBadge.style.display = "none";
        renderExcelTable(smTable, fallbackCfg);
      } else {
        if (smTable) smTable.innerHTML = "";
        if (smBadge) smBadge.style.display = "none";
      }
      return;
    }

    // Build columns and rows from items
    // Heuristic: if items are objects with fields like name/title/status/startDate/endDate/percentComplete
    const columns = [];
    const rows = [];

    // Determine candidate columns by union of keys from first few items
    const sample = items.slice(0, 10);
    const keySet = new Set();
    sample.forEach(it => {
      if (it && typeof it === "object") {
        Object.keys(it).forEach(k => keySet.add(k));
      }
    });

    // Preferred ordering if present
    const preferred = ["name", "title", "milestone", "status", "owner", "startDate", "endDate", "currentDate", "priorDate", "percentComplete", "notes"];
    const keys = Array.from(keySet);
    const ordered = [];

    preferred.forEach(p => {
      const found = keys.find(k => k.toLowerCase() === p.toLowerCase());
      if (found) {
        ordered.push(found);
      }
    });
    // Add remaining keys
    keys.forEach(k => { if (!ordered.includes(k)) ordered.push(k); });

    // Build columns labels (human-friendly)
    ordered.forEach(k => {
      // Map common keys to nicer labels
      const labelMap = {
        name: "Milestone",
        title: "Milestone",
        milestone: "Milestone",
        status: "Status",
        owner: "Owner",
        startDate: "Start Date",
        endDate: "End Date",
        currentDate: "Current Date",
        priorDate: "Prior Date",
        percentComplete: "% Complete",
        notes: "Notes"
      };
      const label = labelMap[k] || k;
      columns.push(label);
    });

    // Build rows: each item -> { label, values: [...] } compatible with renderExcelTable
    items.forEach(it => {
      if (!it || typeof it !== "object") return;
      const values = ordered.map(k => {
        let v = it[k];
        if (v === null || v === undefined) return "—";
        // Format dates if ISO-like
        if (typeof v === "string" && /^\d{4}-\d{2}-\d{2}T?\d{0,2}:?\d{0,2}:?\d{0,2}/.test(v)) {
          try {
            const d = new Date(v);
            if (!isNaN(d.getTime())) return formatISOToMDY(d.toISOString());
          } catch (e) { /* ignore */ }
        }
        // If object with name/title, prefer that
        if (typeof v === "object") {
          if (v.name) return String(v.name);
          if (v.title) return String(v.title);
          return JSON.stringify(v);
        }
        return String(v);
      });

      // Determine label field (first column)
      const label = values.length ? values[0] : (it.name || it.title || "Milestone");
      rows.push({ label, values });
    });

    const smCfg = { badge: (json?.badge || fallbackCfg?.badge || `As of ${getTodayMDY()}`), columns, rows };

    if (smBadge && smCfg.badge) { smBadge.style.display = "inline-block"; smBadge.textContent = smCfg.badge; }
    else if (smBadge) smBadge.style.display = "none";

    renderExcelTable(smTable, smCfg);
  } catch (err) {
    // On any error, fall back to static config if present
    console.error("[SmartPM] load failed:", err);
    if (fallbackCfg) {
      if (smBadge && fallbackCfg.badge) { smBadge.style.display = "inline-block"; smBadge.textContent = fallbackCfg.badge; }
      else if (smBadge) smBadge.style.display = "none";
      renderExcelTable(smTable, fallbackCfg);
    } else {
      if (smTable) smTable.innerHTML = "";
      if (smBadge) smBadge.style.display = "none";
    }
  }
}

/* ============================================================
   Cash Flow Loader (corrected for real KV structure)
   ============================================================ */
async function loadCashFlowFromWorker() {
  try {
    const res = await fetch("https://eg-executive-dashboard.bshives.workers.dev/cash-flow", {
      method: "GET",
      headers: { "Content-Type": "application/json" }
    });

    const text = await res.text();
    let json;
    try { json = JSON.parse(text); }
    catch { return null; }

    // Must have both updatedAt and cashFlow array
    if (!json || !Array.isArray(json.cashFlow)) return null;

    const updatedAt = json.updatedAt || null;   // ⭐ NEW

    const arr = json.cashFlow;
    if (!arr.length) return null;

    const header = arr[0];
    const rowsSource = arr.slice(1);

    const columns = [
      header.chargeType,
      header.revisedBankSOV,
      header.amountBilled,
      header.percentBilled,
      header.balanceToBill
    ];

    const rows = [];

    rowsSource.forEach(r => {
      if (!r) return;

      const t = r.type;
      const ct = (r.chargeType || "").trim();

      if (t === "section") {
        rows.push({ section: ct });
        return;
      }

      if (t === "subtotal") {
        rows.push({
          subtotal: true,
          label: ct,
          values: [
            r.revisedBankSOV ?? "—",
            r.amountBilled ?? "—",
            r.percentBilled ?? "—",
            r.balanceToBill ?? "—"
          ]
        });
        rows.push({ divider: true });
        return;
      }

      if (t === "grandTotal") {
        rows.push({
          total: true,
          label: ct,
          values: [
            r.revisedBankSOV ?? "—",
            r.amountBilled ?? "—",
            r.percentBilled ?? "—",
            r.balanceToBill ?? "—"
          ]
        });
        return;
      }

      if (t === "row") {
        rows.push({
          label: ct,
          values: [
            r.revisedBankSOV ?? "—",
            r.amountBilled ?? "—",
            r.percentBilled ?? "—",
            r.balanceToBill ?? "—"
          ]
        });
      }
    });

    return { updatedAt, columns, rows };   // ⭐ NEW
  } catch (err) {
    console.error("[CashFlow] load failed:", err);
    return null;
  }
}

/* ============================================================
   Project Health Loader (mirrors Cash Flow pattern)
   ============================================================ */
async function loadProjectHealthFromWorker() {
  try {
    const res = await fetch("https://eg-executive-dashboard.bshives.workers.dev/project-health", {
      method: "GET",
      headers: { "Content-Type": "application/json" }
    });

    const text = await res.text();
    let json;
    try { json = JSON.parse(text); }
    catch { return null; }

    // Must have both updatedAt and projectHealth array
    if (!json || !Array.isArray(json.projectHealth)) return null;

    const updatedAt = json.updatedAt || null;

    const arr = json.projectHealth;
    if (!arr.length) return null;

    const header = arr[0];
    const rowsSource = arr.slice(1);

    const columns = [
      header.chargeType,
      header.originalContract,
      header.changeOrders,
      header.revisedBankSOV,
      header.costRisk,
      header.currentRemaining
    ];

    const rows = [];

    rowsSource.forEach(r => {
      if (!r) return;

      const t = r.type;
      const ct = (r.chargeType || "").trim();

      // Section header
      if (t === "section") {
        rows.push({ section: ct });
        return;
      }

      // Subtotal row
      if (t === "subtotal") {
        rows.push({
          subtotal: true,
          label: ct,
          values: [
            r.originalContract ?? "—",
            r.changeOrders ?? "—",
            r.revisedBankSOV ?? "—",
            r.costRisk ?? "—",
            r.currentRemaining ?? "—"
          ]
        });
        rows.push({ divider: true });
        return;
      }

      // Grand Total row
      if (t === "grandTotal") {
        rows.push({
          total: true,
          label: ct,
          values: [
            r.originalContract ?? "—",
            r.changeOrders ?? "—",
            r.revisedBankSOV ?? "—",
            r.costRisk ?? "—",
            r.currentRemaining ?? "—"
          ]
        });
        return;
      }

      // Normal row
      if (t === "row") {
        rows.push({
          label: ct,
          values: [
            r.originalContract ?? "—",
            r.changeOrders ?? "—",
            r.revisedBankSOV ?? "—",
            r.costRisk ?? "—",
            r.currentRemaining ?? "—"
          ]
        });
      }
    });

    return { updatedAt, columns, rows };
  } catch (err) {
    console.error("[ProjectHealth] load failed:", err);
    return null;
  }
}

/* ============================================================
   Health Notes Loader (mirrors Cash Flow pattern)
   ============================================================ */
async function loadHealthNotesFromWorker() {
  try {
    const res = await fetch("https://eg-executive-dashboard.bshives.workers.dev/health-notes");
    const text = await res.text();

    let json;
    try { json = JSON.parse(text); }
    catch { return null; }

    if (!json || !Array.isArray(json.healthNotes)) return null;

    return {
      updatedAt: json.updatedAt || null,
      notes: json.healthNotes
    };

  } catch (err) {
    console.error("[HealthNotes] load failed:", err);
    return null;
  }
}

/* ============================================================
Profit Summary Loader
============================================================ */
async function loadProfitSummaryFromWorker() {
  try {
    const res = await fetch("https://eg-executive-dashboard.bshives.workers.dev/profit-summary", {
      method: "GET",
      headers: { "Content-Type": "application/json" }
    });

    const text = await res.text();
    let json;

    try { json = JSON.parse(text); }
    catch { return null; }

    if (!json || !json.profitSummary) return null;

    return {
      updatedAt: json.updatedAt || null,
      profitSummary: json.profitSummary
    };

  } catch (err) {
    console.error("[ProfitSummary] load failed:", err);
    return null;
  }
}

/* ============================================================
GC Projections Loader
============================================================ */
async function loadGCProjectionsFromWorker() {
  try {
    const res = await fetch("https://eg-executive-dashboard.bshives.workers.dev/gc-projections", {
      method: "GET",
      headers: { "Content-Type": "application/json" }
    });

    if (!res.ok) return null;
    return await res.json();
  } catch (err) {
    console.error("[GCProjections] load failed:", err);
    return null;
  }
}


/* ============================================================
   Entrata + DroneDeploy usage and renderProject
   ============================================================ */
function getEntrataBasicAuthHeader(project) {
  const u = project?.entrataBoxScore?.basicAuth?.username || "";
  const p = project?.entrataBoxScore?.basicAuth?.password || "";
  if (!u || !p) return null;
  const token = btoa(`${u}:${p}`);
  return `Basic ${token}`;
}

async function fetchEntrataBoxScore(project) {
  const payload = buildEntrataRpcPayload(project);
  if (!payload) throw new Error("Entrata payload missing.");

  const res = await fetch("https://eg-executive-dashboard.bshives.workers.dev/entrata", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  const text = await res.text();
  let json;
  try { json = JSON.parse(text); }
  catch { throw new Error(`Entrata Worker returned non-JSON: ${text.slice(0, 200)}`); }

  if (!res.ok) {
    throw new Error(`Entrata Worker error: ${json?.message || text.slice(0, 200)}`);
  }

  return json;
}

function extractAvailabilityRows(entrataJson) {
  const availability =
    entrataJson?.response?.result?.[0]?.reportData?.availability;

  return Array.isArray(availability) ? availability : [];
}

function computeBoxScoreTotals(availabilityRows) {
  const totals = {
    total_units: 0,
    excluded_units: 0,
    total_rentable_units: 0,
    occupied_units: 0,
    vacant_units: 0,
    available_units: 0,
    occupied_no_notice_units: 0,
    notice_rented_units: 0,
    notice_unrented_units: 0,
    vacant_rented_units: 0,
    vacant_unrented_units: 0,

    avg_square_feet: null,
    avg_market_rent: null,
    scheduled_rent: null,

    percent_occupied: null,
    percent_leased: null,
    avg_not_exposed_leased_units: null,
    avg_exposure: null
  };

  let wUnits = 0;
  let wRentable = 0;

  let sumSqFt = 0;
  let sumMarket = 0;
  let sumScheduled = 0;

  let sumPctOcc = 0;
  let sumPctLeased = 0;
  let sumPctTrend = 0;
  let sumPctExposure = 0;

  availabilityRows.forEach(r => {
    const tu = safeNumber(r.total_units);
    const tr = safeNumber(r.total_rentable_units);

    totals.total_units += tu;
    totals.excluded_units += safeNumber(r.excluded_units);
    totals.total_rentable_units += tr;
    totals.occupied_units += safeNumber(r.occupied_units);
    totals.vacant_units += safeNumber(r.vacant_units);
    totals.available_units += safeNumber(r.available_units);
    totals.occupied_no_notice_units += safeNumber(r.occupied_no_notice_units);
    totals.notice_rented_units += safeNumber(r.notice_rented_units);
    totals.notice_unrented_units += safeNumber(r.notice_unrented_units);
    totals.vacant_rented_units += safeNumber(r.vacant_rented_units);
    totals.vacant_unrented_units += safeNumber(r.vacant_unrented_units);

    if (tu > 0) {
      wUnits += tu;
      sumSqFt += safeNumber(r.avg_square_feet) * tu;
      sumMarket += safeNumber(r.avg_market_rent) * tu;
      sumScheduled += safeNumber(r.scheduled_rent) * tu;
    }

    if (tr > 0) {
      wRentable += tr;
      sumPctOcc += safeNumber(r.percent_occupied) * tr;
      sumPctLeased += safeNumber(r.percent_leased) * tr;
      sumPctTrend += safeNumber(r.avg_not_exposed_leased_units) * tr;
      sumPctExposure += safeNumber(r.avg_exposure) * tr;
    }
  });

  if (wUnits > 0) {
    totals.avg_square_feet = sumSqFt / wUnits;
    totals.avg_market_rent = sumMarket / wUnits;
    totals.scheduled_rent = sumScheduled / wUnits;
  }

  if (wRentable > 0) {
    totals.percent_occupied = sumPctOcc / wRentable;
    totals.percent_leased = sumPctLeased / wRentable;
    totals.avg_not_exposed_leased_units = sumPctTrend / wRentable;
    totals.avg_exposure = sumPctExposure / wRentable;
  } else if (totals.total_rentable_units > 0) {
    totals.percent_occupied = totals.occupied_units / totals.total_rentable_units;
    totals.percent_leased = (totals.occupied_units + totals.vacant_rented_units + totals.notice_rented_units) / totals.total_rentable_units;
    totals.avg_exposure = 1 - (totals.percent_leased || 0);
    totals.avg_not_exposed_leased_units = totals.percent_leased;
  }

  return totals;
}

function renderLeasingActivityTable(tableEl, project, totalsOrNull) {
  if (!tableEl) return;

  const cfg = project?.leasingActivity;
  const rows = Array.isArray(cfg?.rows) ? cfg.rows : [];

  tableEl.innerHTML = "";

  rows.forEach(r => {
    if (r && r.divider) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<th class="excel-muted"> </th><td class="excel-muted"> </td>`;
      tableEl.appendChild(tr);
      return;
    }

    const label = r.label || "";
    const key = r.key;

    let raw = totalsOrNull ? totalsOrNull[key] : null;
    let val = "—";

    switch (r.format) {
      case "int": val = formatInt(raw); break;
      case "number2": val = formatNumber2(raw); break;
      case "currency2": val = formatCurrency2(raw); break;
      case "percent2": val = formatPercent2(raw); break;
      default:
        val = (raw === null || raw === undefined) ? "—" : String(raw);
        break;
    }

    const tr = document.createElement("tr");
    tr.innerHTML = `<th>${escapeHtml(label)}</th><td>${escapeHtml(val)}</td>`;
    tableEl.appendChild(tr);
  });
}

/* ============================================================
   DroneDeploy helpers continued (already included above)
   ============================================================ */

async function ddGraphQL(query, variables = {}) {
  const res = await fetch("https://eg-executive-dashboard.bshives.workers.dev/drone", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ query, variables })
  });

  const text = await res.text();
  let json;
  try { json = JSON.parse(text); }
  catch { throw new Error(`Non-JSON response from Worker: ${text.slice(0, 200)}`); }

  if (!res.ok) {
    throw new Error(`DroneDeploy Worker error: ${json?.errors?.[0]?.message || text.slice(0, 200)}`);
  }

  return json.data;
}

/* ddGetLatestPhotoGroupPlanId, ddGetProgressPhotoPlanPhotos, ddLoadLatestGalleryForProject,
   renderGallery, renderBulletsIntoList already defined above and used below. */

/* ============================================================
   Main renderProject function (uses SmartPM loader above)
   ============================================================ */
async function renderProject(key) {
  const project = projects[key];
  if (!project) return;

  const todayMDY = getTodayMDY();
  const isCover = (key === "tgcportfolio");

  const mainGrid = content.querySelector(".main-grid");
  if (mainGrid) {
    mainGrid.classList.toggle("is-portfolio", isCover);
    mainGrid.classList.toggle("is-project", !isCover);
  }

  content.querySelector(".project-header h2").textContent = project.name;
  content.querySelector(".project-header h3").textContent =
    isCover ? `Project Health, CAC Variance, & More` : project.location;

  /* COVER cards */
  setCardVisibility("coverProjectHealthSummaryCard", isCover);
  setCardVisibility("coverCACVarianceOverviewCard", isCover);
  setCardVisibility("coverPortfolioLeasingUpdateCard", isCover);

  if (isCover) {
    setCardVisibility("projectScheduleCard", false);
    setCardVisibility("weeklyCACNotesCard", false);
    setCardVisibility("scheduleVarianceCard", false);
    setCardVisibility("smartPMKeyMilestonesCard", false);

    setCardVisibility("projectHealthCard", false);
    setCardVisibility("cashFlowCard", false);
    setCardVisibility("profitSummaryCard", false);
    setCardVisibility("leasingCard", false);
    setCardVisibility("galleryCard", false);
    setCardVisibility("notesCard", false);
    setCardVisibility("assetManagementCard", false);
    setCardVisibility("mapCard", false);

    const c1 = project.coverProjectHealthSummary;
    const c2 = project.coverCACVarianceOverview;
    const c3 = project.coverPortfolioLeasingUpdate;

    const c1Table = document.getElementById("coverProjectHealthSummaryTable");
    const c2Table = document.getElementById("coverCACVarianceOverviewTable");
    const c3Table = document.getElementById("coverPortfolioLeasingUpdateTable");

    const c1Badge = document.getElementById("coverProjectHealthSummaryBadge");
    const c2Badge = document.getElementById("coverCACVarianceOverviewBadge");
    const c3Badge = document.getElementById("coverPortfolioLeasingUpdateBadge");

    if (c1 && c1.columns && c1.rows) {
      if (c1Badge && c1.badge) { c1Badge.style.display = "inline-block"; c1Badge.textContent = c1.badge; }
      else if (c1Badge) c1Badge.style.display = "none";
      renderExcelTable(c1Table, c1);
    } else if (c1Table) c1Table.innerHTML = "";

    if (c2 && c2.columns && c2.rows) {
      if (c2Badge && c2.badge) { c2Badge.style.display = "inline-block"; c2Badge.textContent = c2.badge; }
      else if (c2Badge) c2Badge.style.display = "none";
      renderExcelTable(c2Table, c2);
    } else if (c2Table) c2Table.innerHTML = "";

    if (c3 && c3.columns && c3.rows) {
      if (c3Badge && c3.badge) { c3Badge.style.display = "inline-block"; c3Badge.textContent = c3.badge; }
      else if (c3Badge) c3Badge.style.display = "none";
      renderExcelTable(c3Table, c3);
    } else if (c3Table) c3Table.innerHTML = "";

    updateExcelScrollbarPadding(content);
    attachExcelWrapObservers(content);

    if (__ddIntervalHandle) { clearInterval(__ddIntervalHandle); __ddIntervalHandle = null; }
    if (__entrataIntervalHandle) { clearInterval(__entrataIntervalHandle); __entrataIntervalHandle = null; }

    return;
  }

  /* PROJECT PAGES */
  setCardVisibility("projectScheduleCard", true);
  setCardVisibility("scheduleVarianceCard", true);
  setCardVisibility("projectHealthCard", true);
  setCardVisibility("cashFlowCard", true);
  setCardVisibility("profitSummaryCard", true);
  setCardVisibility("leasingCard", true);
  setCardVisibility("galleryCard", true);
  setCardVisibility("notesCard", true);
  setCardVisibility("assetManagementCard", true);
  setCardVisibility("mapCard", true);

  /* Garrett Mesa-only extras */
  const isGarrettMesa = (key === "garrettmesa");
  setCardVisibility("weeklyCACNotesCard", isGarrettMesa);
  setCardVisibility("smartPMKeyMilestonesCard", isGarrettMesa);

  if (isGarrettMesa) {
    renderBulletsIntoList(document.getElementById("weeklyCACNotesList"), project.weeklyCACNotes || []);

    const smTable = document.getElementById("smartPMKeyMilestonesTable");
    const smBadge = document.getElementById("smartPMKeyMilestonesBadge");

    // Use the Worker endpoint first, fall back to static project.smartPMKeyMilestones
    await loadSmartPMFromWorkerOrFallback(project, smTable, smBadge);
  }

  /* Notes & Updates bullets */
  const notesUl = document.querySelector("#notesCard ul");
  if (notesUl) {
    notesUl.innerHTML = "";
    (project.highlights || []).forEach(item => {
      const li = document.createElement("li");
      li.textContent = item;
      notesUl.appendChild(li);
    });
  }

  /* Leasing Activity + Entrata badge */
  const leasingTableEl = document.querySelector("#leasingCard table");
  const entrataBadgeEl = document.getElementById("entrataBoxScoreBadge");

  if (__entrataIntervalHandle) { clearInterval(__entrataIntervalHandle); __entrataIntervalHandle = null; }

  const shouldUseEntrata = isGarrettMesa && !!project.entrataBoxScore;

  // Always set badge “in the usual location” for Garrett Mesa.
  if (entrataBadgeEl) {
    if (shouldUseEntrata) {
      entrataBadgeEl.style.display = "inline-block";
      entrataBadgeEl.textContent = `As of ${todayMDY}`;
    } else {
      entrataBadgeEl.style.display = "none";
    }
  }

  const loadAndRenderEntrataLeasing = async () => {
    try {
      const cacheKey = `entrata:box_score:${key}`;
      const refreshMs = project?.leasingActivity?.refreshMs || (15 * 60 * 1000);
      const cached = __entrataCache.get(cacheKey);

      let leasingTotals = null;

      if (cached && (Date.now() - cached.ts) < refreshMs) {
        leasingTotals = cached.totals || null;
      } else {
        const json = await fetchEntrataBoxScore(project);
        const avail = extractAvailabilityRows(json);
        const totals = computeBoxScoreTotals(avail);
        __entrataCache.set(cacheKey, { ts: Date.now(), payload: json, totals });
        leasingTotals = totals;
      }

      renderLeasingActivityTable(leasingTableEl, project, leasingTotals);
      return true;
    } catch (err) {
      console.error("[Entrata] Leasing Activity load failed:", err);
      renderLeasingActivityTable(leasingTableEl, project, null);
      return false;
    }
  };

  if (shouldUseEntrata) {
    const ok = await loadAndRenderEntrataLeasing();
    if (ok) {
      const refreshMs = project?.leasingActivity?.refreshMs || (15 * 60 * 1000);
      __entrataIntervalHandle = setInterval(async () => {
        if (selector.value === key) await loadAndRenderEntrataLeasing();
      }, refreshMs);
    }
  } else {
    if (leasingTableEl) leasingTableEl.innerHTML = "";
  }

  /* Project Health (live from Worker KV) */
const phTable = document.getElementById("projectHealthTable");
const phBadge = document.getElementById("projectHealthAsOfBadge");

try {
  const phCfg = await loadProjectHealthFromWorker();

  if (phCfg && phCfg.columns && phCfg.rows) {

    // Use Worker timestamp if available, otherwise fallback to today
    const updated = phCfg.updatedAt
      ? formatISOToMDY(phCfg.updatedAt)
      : todayMDY;

    phBadge.style.display = "inline-block";
    phBadge.textContent = `As of ${updated}`;

    renderExcelTable(phTable, phCfg);

  } else {
    setCardVisibility("projectHealthCard", false);
    if (phTable) phTable.innerHTML = "";
  }

} catch (err) {
  console.error("[ProjectHealth] render failed:", err);
  setCardVisibility("projectHealthCard", false);
  if (phTable) phTable.innerHTML = "";
}


  /* Cash Flow (live from Worker KV) */
const cfTable = document.getElementById("cashFlowTable");
const cfBadge = document.getElementById("cashFlowAsOfBadge");

try {
  const cfCfg = await loadCashFlowFromWorker();

  if (cfCfg && cfCfg.columns && cfCfg.rows) {

    // ⭐ Use Worker timestamp if available, otherwise fallback to today
    const updated = cfCfg.updatedAt
      ? formatISOToMDY(cfCfg.updatedAt)
      : todayMDY;

    cfBadge.style.display = "inline-block";
    cfBadge.textContent = `As of ${updated}`;

    renderExcelTable(cfTable, cfCfg);

  } else {
    setCardVisibility("cashFlowCard", false);
    if (cfTable) cfTable.innerHTML = "";
  }

} catch (err) {
  console.error("[CashFlow] render failed:", err);
  setCardVisibility("cashFlowCard", false);
  if (cfTable) cfTable.innerHTML = "";
}

/* Health Notes (live from Worker KV) */
const hnList = document.getElementById("healthNotesList");

try {
  const hnCfg = await loadHealthNotesFromWorker();

  if (hnCfg && Array.isArray(hnCfg.notes)) {
    if (hnList) {
      hnList.innerHTML = "";
      hnCfg.notes.forEach(n => {
        const li = document.createElement("li");
        li.textContent = n;
        hnList.appendChild(li);
      });
    }

    setCardVisibility("notesCard", true);
  } else {
    setCardVisibility("notesCard", false);
    if (hnList) hnList.innerHTML = "";
  }

} catch (err) {
  console.error("[HealthNotes] render failed:", err);
  setCardVisibility("notesCard", false);
  if (hnList) hnList.innerHTML = "";
}

/* GC Projections (live from Worker KV) */
function renderGCProjections(gcp) {
  if (!gcp) return;

  const fmtTotal = (n) => {
    if (n === null || n === undefined) return "—";
    const num = Number(String(n).replace(/[^0-9.-]/g, ""));
    if (isNaN(num)) return n;
    if (num >= 1_000_000) return `$${(num / 1_000_000).toFixed(1)}M`;
    if (num >= 1_000) return `$${(num / 1_000).toFixed(0)}K`;
    return `$${num.toLocaleString()}`;
  };

  const fmtMonths = (n) => {
    if (n === null || n === undefined) return "—";
    const num = Number(n);
    if (isNaN(num)) return n;
    return num.toFixed(2);
  };

  // SWAG PER MONTH
  document.getElementById("gc-swag-total").textContent =
    fmtTotal(gcp.swagPerMonth);

  // MONTHS REMAINING
  document.getElementById("gc-months-total").textContent =
    fmtMonths(gcp.monthsRemaining);

  document.getElementById("gc-months-details").innerHTML =
    `<b>Estimated Finish:</b> ${gcp.estimatedFinish || "—"}`;

  // GC COST REMAINING
  document.getElementById("gc-cost-total").textContent =
    fmtTotal(gcp.gcCostRemaining);

  // Click-to-toggle ONLY for Months Remaining
  const monthsCard = document.getElementById("gc-months-card");
  const monthsDetails = document.getElementById("gc-months-details");

  if (monthsCard && monthsDetails) {
    monthsDetails.style.display = "none";
    monthsCard.style.cursor = "pointer";
    monthsCard.onclick = () => {
      monthsDetails.style.display =
        monthsDetails.style.display === "none" ? "block" : "none";
    };
  }
}

/* ============================================================
Profit Summary Renderer
============================================================ */
function renderProfitSummary(ps) {
  if (!ps) return;

  const fmtFull = (n) => {
  if (n === null || n === undefined) return "—";
  const num = Number(String(n).replace(/[^0-9.-]/g, ""));
  if (isNaN(num)) return n;
  return `$${num.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
};

  
  const fmt = (n) => {
    if (n === null || n === undefined) return "—";
    const num = Number(n);
    if (isNaN(num)) return n;
    if (num >= 1_000_000) return `$${(num / 1_000_000).toFixed(1)}M`;
    if (num >= 1_000) return `$${(num / 1_000).toFixed(0)}K`;
    return `$${num.toLocaleString()}`;
  };

  // ORIGINAL
  document.getElementById("profit-original-total").textContent = fmt(ps.original.total);
  document.getElementById("profit-original-details").innerHTML =
    `<b>Construction:</b> ${fmtFull(ps.original.construction)}<br>` + `<b>Development:</b> ${fmtFull(ps.original.development)}<br>`;

  // ACTUAL
  document.getElementById("profit-actual-total").textContent = fmt(ps.actual.total);
  document.getElementById("profit-actual-details").innerHTML =
    `<b>Construction:</b> ${fmtFull(ps.actual.construction)}<br>` + `<b>Development:</b> ${fmtFull(ps.actual.development)}<br>`;

  // VARIANCE
  document.getElementById("profit-variance-total").textContent = fmt(ps.variance.total);
  document.getElementById("profit-variance-details").innerHTML =
    `<b>Construction:</b> ${fmtFull(ps.variance.construction)}<br>` + `<b>Development:</b> ${fmtFull(ps.variance.development)}<br>`;
    
    // === Variance shading overlay ===
const varianceCard = document.getElementById("profit-variance-card");
const vNum = parseMoneyishToNumber(ps.variance.total);

// remove old classes
varianceCard.classList.remove("variance-positive", "variance-negative");

// apply new shading
if (typeof vNum === "number") {
  if (vNum > 0) {
    varianceCard.classList.add("variance-positive");
  } else if (vNum < 0) {
    varianceCard.classList.add("variance-negative");
  }
}

// === Big number text coloring ===
const varianceTotalEl = document.getElementById("profit-variance-total");
varianceTotalEl.classList.remove("variance-positive", "variance-negative");

if (typeof vNum === "number") {
  if (vNum > 0) {
    varianceTotalEl.classList.add("variance-positive");
  } else if (vNum < 0) {
    varianceTotalEl.classList.add("variance-negative");
  }
}


}

loadProfitSummaryFromWorker().then(data => {
  if (data && data.profitSummary) {
    renderProfitSummary(data.profitSummary);
  }
});

  // restore click-to-toggle behavior
  ["original", "actual", "variance"].forEach(type => {
    const card = document.getElementById(`profit-${type}-card`);
    const details = document.getElementById(`profit-${type}-details`);
    if (card && details) {
      details.style.display = "none";
      card.style.cursor = "pointer";
      card.onclick = () => {
        details.style.display = (details.style.display === "none") ? "block" : "none";
      };
    }
  });
  
/* ============================================================
GC Projections Renderer
============================================================ */
function renderGCProjections(gcp) {
  if (!gcp) return;

  const fmtTotal = (n) => {
    if (n === null || n === undefined) return "—";
    const num = Number(String(n).replace(/[^0-9.-]/g, ""));
    if (isNaN(num)) return n;
    if (num >= 1_000_000) return `$${(num / 1_000_000).toFixed(1)}M`;
    if (num >= 1_000) return `$${(num / 1_000).toFixed(0)}K`;
    return `$${num.toLocaleString()}`;
  };

  const fmtMonths = (n) => {
    if (n === null || n === undefined) return "—";
    const num = Number(n);
    if (isNaN(num)) return n;
    return num.toFixed(2);
  };

  // SWAG PER MONTH
  document.getElementById("gc-swag-total").textContent =
    fmtTotal(gcp.swagPerMonth);

  // MONTHS REMAINING
  document.getElementById("gc-months-total").textContent =
    fmtMonths(gcp.monthsRemaining);

  document.getElementById("gc-months-details").innerHTML =
    `<b>Estimated Finish:</b> ${gcp.estimatedFinish || "—"}`;

  // GC COST REMAINING
  document.getElementById("gc-cost-total").textContent =
    fmtTotal(gcp.gcCostRemaining);

  // Click-to-toggle ONLY for Months Remaining
  const monthsCard = document.getElementById("gc-months-card");
  const monthsDetails = document.getElementById("gc-months-details");

  if (monthsCard && monthsDetails) {
    monthsDetails.style.display = "none";
    monthsCard.style.cursor = "pointer";
    monthsCard.onclick = () => {
      monthsDetails.style.display =
        monthsDetails.style.display === "none" ? "block" : "none";
    };
  }
}

/* ============================================================
GC Projections Hook (matches Profit Summary pattern)
============================================================ */
loadGCProjectionsFromWorker().then(data => {
  if (data && data.gcProjections) {
    renderGCProjections(data.gcProjections);
  }
});


  /* CAC Variance Update */
  const psTable = document.getElementById("projectScheduleTable");
  const psBadge = document.getElementById("projectScheduleBadge");
  const psCfg = project.projectScheduleUpdate;
  if (psCfg && psCfg.columns && psCfg.rows) {
    if (psCfg.badge) {
      psBadge.style.display = "inline-block";
      psBadge.textContent = psCfg.badge;
    } else {
      psBadge.style.display = "none";
    }
    renderExcelTable(psTable, psCfg);
  } else {
    setCardVisibility("projectScheduleCard", false);
    if (psTable) psTable.innerHTML = "";
    if (psBadge) psBadge.style.display = "none";
  }

  /* Schedule Variance Update */
  const svTable = document.getElementById("scheduleVarianceTable");
  const svBadge = document.getElementById("scheduleVarianceBadge");
  const svCfg = project.scheduleVarianceUpdate;
  if (svCfg && svCfg.columns && svCfg.rows) {
    if (svCfg.badge) {
      svBadge.style.display = "inline-block";
      svBadge.textContent = svCfg.badge;
    } else {
      svBadge.style.display = "none";
    }
    renderExcelTable(svTable, svCfg);
  } else {
    setCardVisibility("scheduleVarianceCard", false);
    if (svTable) svTable.innerHTML = "";
    if (svBadge) svBadge.style.display = "none";
  }

  /* Asset Management Tracker */
  const amTable = document.getElementById("assetManagementTable");
  const amBadge = document.getElementById("assetManagementBadge");
  const amCfg = project.assetManagementTracker;
  if (amCfg && amCfg.columns && amCfg.rows) {
    if (amBadge && amCfg.badge) { amBadge.style.display = "inline-block"; amBadge.textContent = amCfg.badge; }
    else if (amBadge) amBadge.style.display = "none";
    renderExcelTable(amTable, amCfg);
  } else {
    setCardVisibility("assetManagementCard", false);
    if (amTable) amTable.innerHTML = "";
    if (amBadge) amBadge.style.display = "none";
  }

  updateExcelScrollbarPadding(content);
  attachExcelWrapObservers(content);

  /* Logo-to-home behavior */
  function goToFullPortfolio(scrollToTop = true) {
    if (stateSelector) {
      stateSelector.value = "all";
      stateSelector.dispatchEvent(new Event("change", { bubbles: true }));
    }

    if (selector) {
      let opt = selector.querySelector('option[value="tgcportfolio"]');
      if (!opt) {
        opt = new Option("Full TGC Portfolio", "tgcportfolio");
        selector.insertBefore(opt, selector.firstChild);
      }
      selector.value = "tgcportfolio";
      selector.dispatchEvent(new Event("change", { bubbles: true }));
    }

    if (typeof renderProject === "function") renderProject("tgcportfolio");
    if (scrollToTop) window.scrollTo({ top: 0, behavior: "smooth" });
  }

  const logoDesktop = document.getElementById("logoLinkDesktop");
  const logoMobile = document.getElementById("logoLinkMobile");
  if (logoDesktop) logoDesktop.onclick = (e) => { e.preventDefault(); goToFullPortfolio(); };
  if (logoMobile) logoMobile.onclick = (e) => { e.preventDefault(); goToFullPortfolio(); };

  /* Gallery */
  const renderingDiv = document.getElementById("galleryCard");

  if (__ddIntervalHandle) { clearInterval(__ddIntervalHandle); __ddIntervalHandle = null; }

  const loadDD = async () => {
    try {
      const dd = await ddLoadLatestGalleryForProject(project, renderingDiv);
      if (dd && dd.photos && dd.photos.length) {
        const urls = dd.photos.map(p => p.url);
        const badge = dd.latestDateISO ? `As of ${formatISOToMDY(dd.latestDateISO)}` : "";
        renderGallery(renderingDiv, urls, badge, "");
        return true;
      }
      return false;
    } catch (err) {
      console.error("[DroneDeploy] Gallery load failed:", err);
      const msg = String(err && err.message ? err.message : err);
      renderGallery(
        renderingDiv,
        (project.renderings || []),
        "",
        msg.includes("Failed to fetch") ? "DroneDeploy blocked (CORS). Using fallback images." : "DroneDeploy error. Using fallback images."
      );
      return false;
    }
  };

  if (project.droneDeploy && project.droneDeploy.projectId) {
    const ok = await loadDD();
    if (ok) {
      __ddIntervalHandle = setInterval(async () => {
        if (selector.value === key) await loadDD();
      }, DRONEDEPLOY_REFRESH_MS);
    }
  } else {
    renderGallery(renderingDiv, (project.renderings || []));
  }

  /* Map */
  const iframe = document.querySelector("#mapCard iframe");
  if (iframe) iframe.src = project.mapUrl || "";

  /* Heading swaps (targeted by ID so Weekly CAC Notes doesn’t interfere) */
  const notesH4 = document.querySelector("#notesCard h4");
  const leasingH4 = document.querySelector("#leasingCard h4");

  if (key === "tgcportfolio") {
    if (notesH4) notesH4.textContent = "Portfolio Highlights";
    if (leasingH4) leasingH4.textContent = "Pipeline Details";
  } else {
    if (notesH4) notesH4.textContent = "Health Notes & Updates";
    if (leasingH4) leasingH4.textContent = "Entrata Box Score";
  }
}

function plusSlides(n) {
  showSlides(slideIndex += n);
}

function showSlides(n) {
  const slides = document.querySelectorAll(".gallery-slide");
  if (slides.length === 0) return;
  if (n > slides.length) slideIndex = 1;
  if (n < 1) slideIndex = slides.length;
  slides.forEach(s => s.style.display = "none");
  slides[slideIndex - 1].style.display = "block";
}

renderProject(selector.value || Object.keys(projects)[0]);
selector.addEventListener("change", e => renderProject(e.target.value));
window.addEventListener("resize", () => updateExcelScrollbarPadding(content));
</script>
</body>
</html>
